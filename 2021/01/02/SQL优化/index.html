

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Wick">
  <meta name="keywords" content="">
  
    <meta name="description" content="SQL语句性能提升,explain执行计划.">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL语句性能提升">
<meta property="og:url" content="http://www.lifeab.com/2021/01/02/SQL%E4%BC%98%E5%8C%96/index.html">
<meta property="og:site_name" content="我的博客">
<meta property="og:description" content="SQL语句性能提升,explain执行计划.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://nohurry-imgbed.oss-cn-qingdao.aliyuncs.com/imgs/uov1YTpgXFAW7bx.png">
<meta property="og:image" content="https://nohurry-imgbed.oss-cn-qingdao.aliyuncs.com/imgs/FPJBk3ZUbVK9Eli.png">
<meta property="og:image" content="https://nohurry-imgbed.oss-cn-qingdao.aliyuncs.com/imgs/mBeIr3fAGSPZLqt.png">
<meta property="og:image" content="https://nohurry-imgbed.oss-cn-qingdao.aliyuncs.com/imgs/image-20240328173303966.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/nhPkS2TCuWrcGzA.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/WJsj84friFpEq7B.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/uRkcvPQbArmEYVJ.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/d196yFjRzvuwC8O.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/vtYSXkhM8GKAmNy.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/5wTQco1LvV7FEan.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/ZDN1zF2IC4tJL8l.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/HpVSzP5ctUOxX4C.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/RcKYmrQLfxqtUDT.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/seBKYAxgf96SnqT.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/uTwAGnFo8iv124D.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/TaXJYNcr3SPBGDk.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/kEnMAZFh21TR6q9.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/5eQYGLuVTdZ3bKJ.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/RGQ7YvF6mhrwxJo.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/mnRHa4UgSekjiuG.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/8rkhgI94KERP7i6.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/khUqeCluLPzTGOB.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/bUs12rNhJeOGVZo.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/QqZWDExtG1amPj4.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/gwpP7O2Y13AWjRx.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/hZ6bxFES31iHe5U.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/W3iZJFjywgxD5vq.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/nE1w9LgHGBcK2x3.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/BPMWOQzAGDK7U3L.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/r4kIxJOpmMygEuc.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/DXFIvx3KHBpLlOq.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/6aDBX3nVytQCP4z.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/l8DwIRpVJnSi2Ft.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/xEo8Tbgqv46SFMY.png">
<meta property="article:published_time" content="2021-01-02T14:10:17.000Z">
<meta property="article:modified_time" content="2024-04-01T02:44:39.779Z">
<meta property="article:author" content="John Wick">
<meta property="article:tag" content="sql - java">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://nohurry-imgbed.oss-cn-qingdao.aliyuncs.com/imgs/uov1YTpgXFAW7bx.png">
  
  
  
  <title>SQL语句性能提升 - 我的博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.lifeab.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":3},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Freedom is as important as breathing</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="SQL语句性能提升"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-01-02 22:10" pubdate>
          2021年1月2日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          4.8k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          40 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">SQL语句性能提升</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="1-数据准备"><a href="#1-数据准备" class="headerlink" title="1.数据准备"></a>1.数据准备</h1><blockquote>
<p>1). 准备tb_sku表, 导入数据 - 数据1000w</p>
<p>2). 准备tb_seller表,导入数据 - 数据12条 </p>
</blockquote>
<h1 id="2-慢查询分析"><a href="#2-慢查询分析" class="headerlink" title="2.慢查询分析"></a>2.慢查询分析</h1><h2 id="2-1-show-profiles"><a href="#2-1-show-profiles" class="headerlink" title="2.1.show profiles"></a>2.1.show profiles</h2><blockquote>
<p><strong>show profiles 是mysql提供可以用来分析当前会话中语句执行的资源消耗情况。可以用于SQL的调优测量,show profiles 能够在做SQL优化时帮助我们了解时间都耗费到哪里去了。</strong></p>
</blockquote>
<p>通过 have_profiling 参数，能够看到当前MySQL<strong>是否支持profile</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> @<span class="hljs-variable">@have_profiling</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+</span><br><span class="hljs-operator">|</span> @<span class="hljs-variable">@have_profiling</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+</span><br><span class="hljs-operator">|</span> YES              <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)<br></code></pre></td></tr></table></figure>

<p>默认profiling是关闭的，可以通过set语句在<strong>Session级别开启profiling</strong>： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> @<span class="hljs-variable">@profiling</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------+</span><br><span class="hljs-operator">|</span> @<span class="hljs-variable">@profiling</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------+</span><br><span class="hljs-operator">|</span>           <span class="hljs-number">0</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------+</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)<br><br></code></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">set</span> profiling<span class="hljs-operator">=</span><span class="hljs-number">1</span>; <span class="hljs-operator">/</span><span class="hljs-operator">/</span>开启profiling 开关；<br></code></pre></td></tr></table></figure>

<p><strong>通过profile，我们能够更清楚地了解SQL执行的过程。</strong><br>首先，我们可以执行一系列的操作:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> databases; <br>use db01; <br><span class="hljs-keyword">show</span> tables; <br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_ksu <span class="hljs-keyword">where</span> id <span class="hljs-operator">&lt;</span> <span class="hljs-number">5</span>; <br><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> tb_ksu;<br></code></pre></td></tr></table></figure>

<p>执行完上述命令之后，再执行<code>show profiles</code> 指令， 来查看SQL语句执行的耗时：<br>通过<code>show profile for query query_id</code> 语句可以查看到该SQL执行过程中每个线程的状态和消耗的时间：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> profiles;<br><span class="hljs-operator">+</span><span class="hljs-comment">----------+------------+---------------------------------+</span><br><span class="hljs-operator">|</span> Query_ID <span class="hljs-operator">|</span> Duration   <span class="hljs-operator">|</span> Query                           <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------+------------+---------------------------------+</span><br><span class="hljs-operator">|</span>        <span class="hljs-number">1</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.00085725</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">show</span> databases                  <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>        <span class="hljs-number">2</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.00020975</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">SELECT</span> DATABASE()               <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>        <span class="hljs-number">3</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.00121950</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">show</span> tables                     <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>        <span class="hljs-number">4</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.00041000</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t_bill <span class="hljs-keyword">where</span> id<span class="hljs-operator">&lt;</span><span class="hljs-number">5</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>        <span class="hljs-number">5</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.00097875</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> t_bill     <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------+------------+---------------------------------+</span><br><span class="hljs-number">5</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.01</span> sec)<br></code></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> profile <span class="hljs-keyword">for</span> query <span class="hljs-number">4</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+</span><br><span class="hljs-operator">|</span> Status                         <span class="hljs-operator">|</span> Duration <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+</span><br><span class="hljs-operator">|</span> starting                       <span class="hljs-operator">|</span> <span class="hljs-number">0.000094</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> Executing hook <span class="hljs-keyword">on</span> transaction  <span class="hljs-operator">|</span> <span class="hljs-number">0.000009</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> starting                       <span class="hljs-operator">|</span> <span class="hljs-number">0.000010</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> checking permissions           <span class="hljs-operator">|</span> <span class="hljs-number">0.000008</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> Opening tables                 <span class="hljs-operator">|</span> <span class="hljs-number">0.000042</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> init                           <span class="hljs-operator">|</span> <span class="hljs-number">0.000009</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> <span class="hljs-keyword">System</span> lock                    <span class="hljs-operator">|</span> <span class="hljs-number">0.000013</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> optimizing                     <span class="hljs-operator">|</span> <span class="hljs-number">0.000012</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> statistics                     <span class="hljs-operator">|</span> <span class="hljs-number">0.000052</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> preparing                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000019</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> executing                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000046</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> <span class="hljs-keyword">end</span>                            <span class="hljs-operator">|</span> <span class="hljs-number">0.000008</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> query <span class="hljs-keyword">end</span>                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000006</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> waiting <span class="hljs-keyword">for</span> handler <span class="hljs-keyword">commit</span>     <span class="hljs-operator">|</span> <span class="hljs-number">0.000011</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> closing tables                 <span class="hljs-operator">|</span> <span class="hljs-number">0.000040</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> freeing items                  <span class="hljs-operator">|</span> <span class="hljs-number">0.000021</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> cleaning up                    <span class="hljs-operator">|</span> <span class="hljs-number">0.000013</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+</span><br><span class="hljs-number">17</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)<br></code></pre></td></tr></table></figure>



<blockquote>
<p>TIP ：</p>
<p>Sending data 状态表示MySQL线程开始访问数据行并把结果返回给客户端，而不仅仅是返回个客户端。 </p>
<p>由于在Sending data状态下，MySQL线程往往需要做大量的磁盘读取操作，所以经常是整各查询中耗时最长的状态。 </p>
<p>MySQL 的查询优化器可能会对查询进行优化，使得某些步骤（如 <code>Sending data</code>）在实际执行过程中被合并或省略，因此在 <code>SHOW PROFILES</code> 的结果中可能看不到这些步骤。</p>
</blockquote>
<p>在获取到最消耗时间的线程状态后，MySQL支持进一步选择all、cpu、block io 、context switch、page faults等明细类型类查看MySQL在使用什么资源上耗费了过高的时间。例如，选择查看CPU的耗费时间 ： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">show</span> profile cpu <span class="hljs-keyword">for</span> query <span class="hljs-number">7</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+----------+------------+</span><br><span class="hljs-operator">|</span> Status                         <span class="hljs-operator">|</span> Duration <span class="hljs-operator">|</span> CPU_user <span class="hljs-operator">|</span> CPU_system <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+----------+------------+</span><br><span class="hljs-operator">|</span> starting                       <span class="hljs-operator">|</span> <span class="hljs-number">0.000081</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000074</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> Executing hook <span class="hljs-keyword">on</span> transaction  <span class="hljs-operator">|</span> <span class="hljs-number">0.000009</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000009</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> starting                       <span class="hljs-operator">|</span> <span class="hljs-number">0.000010</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000009</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> checking permissions           <span class="hljs-operator">|</span> <span class="hljs-number">0.000009</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000009</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> Opening tables                 <span class="hljs-operator">|</span> <span class="hljs-number">0.000032</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000032</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> init                           <span class="hljs-operator">|</span> <span class="hljs-number">0.000007</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000007</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> <span class="hljs-keyword">System</span> lock                    <span class="hljs-operator">|</span> <span class="hljs-number">0.000011</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000010</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> optimizing                     <span class="hljs-operator">|</span> <span class="hljs-number">0.000007</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000007</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> statistics                     <span class="hljs-operator">|</span> <span class="hljs-number">0.000016</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000016</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> preparing                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000019</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000019</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> executing                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000070</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000070</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> <span class="hljs-keyword">end</span>                            <span class="hljs-operator">|</span> <span class="hljs-number">0.000006</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000005</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> query <span class="hljs-keyword">end</span>                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000005</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000006</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> waiting <span class="hljs-keyword">for</span> handler <span class="hljs-keyword">commit</span>     <span class="hljs-operator">|</span> <span class="hljs-number">0.000011</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000025</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> closing tables                 <span class="hljs-operator">|</span> <span class="hljs-number">0.000023</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000009</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> freeing items                  <span class="hljs-operator">|</span> <span class="hljs-number">0.000019</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000019</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span> cleaning up                    <span class="hljs-operator">|</span> <span class="hljs-number">0.000012</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.000012</span> <span class="hljs-operator">|</span>   <span class="hljs-number">0.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+----------+------------+</span><br><span class="hljs-number">17</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.01</span> sec)<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>Status</td>
<td>sql 语句执行的状态</td>
</tr>
<tr>
<td>Duration</td>
<td>sql 执行过程中每一个步骤的耗时</td>
</tr>
<tr>
<td>CPU_user</td>
<td>当前用户占有的cpu</td>
</tr>
<tr>
<td>CPU_system</td>
<td>系统占有的cpu</td>
</tr>
</tbody></table>
<h2 id="2-2-慢查询日志"><a href="#2-2-慢查询日志" class="headerlink" title="2.2 慢查询日志"></a>2.2 慢查询日志</h2><blockquote>
<p><strong>慢查询日志记录了所有执行时间超过参数 long_query_time 设置值并且扫描记录数不小于</strong><br><strong>min_examined_row_limit 的所有的SQL语句的日志。long_query_time 默认为 10 秒，最小</strong><br><strong>为 0， 精度可以到微秒。</strong></p>
</blockquote>
<h3 id="2-2-1-文件位置和格式"><a href="#2-2-1-文件位置和格式" class="headerlink" title="2.2.1 文件位置和格式"></a>2.2.1 文件位置和格式</h3><p>慢查询日志默认是关闭的 。可以通过两个参数来控制慢查询日志 ： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 该参数用来控制慢查询日志是否开启， 可取值： <span class="hljs-number">1</span> 和 <span class="hljs-number">0</span> ， <span class="hljs-number">1</span> 代表开启， <span class="hljs-number">0</span> 代表关闭 <br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> @<span class="hljs-variable">@slow_query_log</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+</span><br><span class="hljs-operator">|</span> @<span class="hljs-variable">@slow_query_log</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+</span><br><span class="hljs-operator">|</span>                <span class="hljs-number">0</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">------------------+</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br># 开启慢查询日志<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">set</span> <span class="hljs-keyword">global</span> slow_query_log<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.00</span> sec)<br><br># 该参数用来指定慢查询日志的文件名 <br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> @<span class="hljs-variable">@slow_query_log_file</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------+</span><br><span class="hljs-operator">|</span> @<span class="hljs-variable">@slow_query_log_file</span>                <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------+</span><br><span class="hljs-operator">|</span> <span class="hljs-operator">/</span>var<span class="hljs-operator">/</span>lib<span class="hljs-operator">/</span>mysql<span class="hljs-operator">/</span><span class="hljs-number">262222839</span>fb5<span class="hljs-operator">-</span>slow.log <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------+</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br><br># 该选项用来配置查询的时间限制， 超过这个时间将认为是慢查询， 将进行日志记录， 默认<span class="hljs-number">10</span>s <br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> @<span class="hljs-variable">@long_query_time</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-operator">|</span> @<span class="hljs-variable">@long_query_time</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-operator">|</span>         <span class="hljs-number">10.000000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)<br># 设置慢查询时间限制<br>mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">set</span> long_query_time<span class="hljs-operator">=</span><span class="hljs-number">11</span>;<br>Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.00</span> sec)<br><br></code></pre></td></tr></table></figure>



<h3 id="2-2-2-日志的读取"><a href="#2-2-2-日志的读取" class="headerlink" title="2.2.2 日志的读取"></a>2.2.2 日志的读取</h3><p>慢查询日志记录的格式也是纯文本，可以被直接读取。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 由于该语句执行时间很短，为0s ， 所以不会记录在慢查询日志中。</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_sku <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;100000030074&#x27;</span>\G;  <span class="hljs-comment">-- \G表示换行显示数据</span><br><span class="hljs-comment">-- 该SQL语句 ， 执行时长为 24.28s ，超过10s ， 所以会记录在慢查询日志文件中。</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_sku <span class="hljs-keyword">where</span> name <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%HuaWei手机Meta87384 Pro%&#x27;</span>\G;<br></code></pre></td></tr></table></figure>

<p>3） 查看慢查询日志文件</p>
<p>直接通过cat 指令查询该日志文件 ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">bash-4.4# cat /var/lib/mysql/262222839fb5-slow.log<br>/usr/sbin/mysqld, Version: 8.2.0 (MySQL Community Server - GPL). started with:<br>Tcp port: 3306  Unix socket: /var/run/mysqld/mysqld.sock<br>Time                 Id Command    Argument<br></code></pre></td></tr></table></figure>

<p><img src="https://nohurry-imgbed.oss-cn-qingdao.aliyuncs.com/imgs/uov1YTpgXFAW7bx.png" srcset="/img/loading.gif" lazyload alt="image-20210127233051622"></p>
<p>如果慢查询日志内容很多， 直接查看文件，比较麻烦， 这个时候可以借助于mysql自带的<code>mysqldumpslow</code> 工具， 来对慢查询日志进行分类汇总。</p>
<p><img src="https://nohurry-imgbed.oss-cn-qingdao.aliyuncs.com/imgs/FPJBk3ZUbVK9Eli.png" srcset="/img/loading.gif" lazyload alt="image-20210127233130483"></p>
<h1 id="3-explain执行计划"><a href="#3-explain执行计划" class="headerlink" title="3. explain执行计划"></a>3. explain执行计划</h1><p>通过以上步骤查询到效率低的 SQL 语句后，可以通过 <code>EXPLAIN</code>或者 DESC命令获取 <code>MySQL</code>如何执行 SELECT 语句的信息，包括在 SELECT 语句执行过程中表如何连接和连接的顺序。</p>
<p>查询SQL语句的执行计划 ： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_sku <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;100000030074&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p><img src="https://nohurry-imgbed.oss-cn-qingdao.aliyuncs.com/imgs/mBeIr3fAGSPZLqt.png" srcset="/img/loading.gif" lazyload alt="image-20210127233204260"></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>select查询的序列号，是一组数字，表示的是查询中执行select子句或者是操作表的顺序。</td>
</tr>
<tr>
<td>Select_type</td>
<td>表示 SELECT 的类型，常见的取值有 SIMPLE（简单表，即不使用表连接或者子查询）、PRIMARY（主查询，即外层的查询）、UNION（UNION 中的第二个或者后面的查询语句）、SUBQUERY（子查询中的第一个SELECT）等</td>
</tr>
<tr>
<td>table</td>
<td>输出结果集的表</td>
</tr>
<tr>
<td><strong>type</strong></td>
<td><strong>表示表的连接类型，性能由好到差的连接类型为( system —&gt; const—–&gt; eq_ref ——&gt; ref ——-&gt; ref_or_null—-&gt;index_merge —&gt; index_subquery —–&gt; range —–&gt;index ——&gt; all )</strong></td>
</tr>
<tr>
<td>possible_keys</td>
<td>表示查询时，可能使用的索引</td>
</tr>
<tr>
<td><strong>key</strong></td>
<td><strong>表示实际使用的索引</strong></td>
</tr>
<tr>
<td>Key_len</td>
<td>索引字段的长度</td>
</tr>
<tr>
<td><strong>rows</strong></td>
<td><strong>扫描行的数量</strong></td>
</tr>
<tr>
<td>Extra</td>
<td>执行情况的说明和描述</td>
</tr>
</tbody></table>
<ul>
<li><p>id 字段是 select查询的序列号是一组数字表示的是查询中执行select子句或者是操作表的顺序。</p>
<ul>
<li>id 相同表示加载表的顺序是从上到下。</li>
<li>id 不同id值越大，优先级越高，越先被执行。</li>
<li>id 有相同，也有不同，同时存在。id相同的可以认为是一组，从上往下顺序执行；在所有的组中，id的值越大，优先级越高，越先执行。</li>
</ul>
</li>
<li><p>select_type</p>
</li>
</ul>
<p>表示 SELECT 的类型，常见的取值，如下表所示：</p>
<p><img src="https://nohurry-imgbed.oss-cn-qingdao.aliyuncs.com/imgs/image-20240328173303966.png" srcset="/img/loading.gif" lazyload alt="image-20240328173303966"></p>
<p>type 显示的是访问类型，是较为重要的一个指标，可取值为：<img src="https://i.loli.net/2021/01/27/nhPkS2TCuWrcGzA.png" srcset="/img/loading.gif" lazyload alt="image-20210127233431857"></p>
<p>一般来说， 我们需要保证查询至少达到 range 级别， 最好达到ref</p>
<p>4). key</p>
<p>A. possible_keys : 显示可能应用在这张表的索引， 一个或多个。</p>
<p>B. key ： 实际使用的索引， 如果为NULL， 则没有使用索引。</p>
<p>C. key_len : 表示索引中使用的字节数， 该值为索引字段最大可能长度，并非实际使用长度，在不损失精确性的前提下， 长度越短越好 。</p>
<p>5). rows</p>
<p>扫描行的数量。</p>
<p>6). filtered</p>
<p>这个字段表示存储引擎返回的数据在server层过滤后，剩下多少满足查询的记录数量的比例。</p>
<h1 id="4-索引的使用"><a href="#4-索引的使用" class="headerlink" title="4. 索引的使用"></a>4. 索引的使用</h1><h2 id="4-1-概述及作用"><a href="#4-1-概述及作用" class="headerlink" title="4.1 概述及作用"></a>4.1 概述及作用</h2><p>MySQL官方对索引的定义为：索引（index）是帮助MySQL高效获取数据的数据结构（有序）。在数据之外，数据库系统还维护者满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据， 这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引。</p>
<p>优势：</p>
<p>1） 类似于书籍的目录索引，提高数据检索的效率，降低数据库的IO成本。</p>
<p>2） 通过索引列对数据进行排序，降低数据排序的成本，降低CPU的消耗。</p>
<p>劣势：</p>
<p>1） 实际上索引也是一张表，该表中保存了主键与索引字段，并指向实体类的记录，所以索引列也是要占用空间的。</p>
<p>2） 虽然索引大大提高了查询效率，同时却也降低更新表的速度，如对表进行INSERT、UPDATE、DELETE。因为更新表时，MySQL 不仅要保存数据，还要保存一下索引文件每次更新添加了索引列的字段，都会调整因为更新所带来的键值变化后的索引信息。</p>
<h2 id="4-2-索引结构"><a href="#4-2-索引结构" class="headerlink" title="4.2 索引结构"></a>4.2 索引结构</h2><p>MySQL数据库中默认的存储引擎InnoDB的索引结构为B+树，而根据叶子节点的内存存储不同，索引类型分为主键索引和非主键索引。</p>
<p>主键索引的叶子节点存储的是整行数据，在InnoDB中主键索引页被称为聚簇索引。其结构如下：<img src="https://i.loli.net/2021/01/27/WJsj84friFpEq7B.png" srcset="/img/loading.gif" lazyload alt="image-20210127233731435"></p>
<p>而非主键索引的叶子节点内容存储的是主键的值，在InnoDB中，非主键索引也被称为二级索引或辅助索引。其结构如下：</p>
<h3 id="4-3-验证索引"><a href="#4-3-验证索引" class="headerlink" title="4.3 验证索引"></a><img src="https://i.loli.net/2021/01/27/uRkcvPQbArmEYVJ.png" srcset="/img/loading.gif" lazyload alt="image-20210102114005619">4.3 验证索引</h3><p>在tb_sku表中一共存在1000w的记录 ;</p>
<p>A. 根据主键ID查询速度很快</p>
<p><img src="https://i.loli.net/2021/01/27/d196yFjRzvuwC8O.png" srcset="/img/loading.gif" lazyload alt="image-20210102114138923">B. 根据name查询速度变慢</p>
<p>C.对name字段建立索引再次查询,速度很快.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> index idx_sku_name <span class="hljs-keyword">on</span> tb_sku(name);<br></code></pre></td></tr></table></figure>

<h2 id="4-4-索引使用规则"><a href="#4-4-索引使用规则" class="headerlink" title="4.4 索引使用规则"></a>4.4 索引使用规则</h2><p>没有建立索引之前, 执行计划如下</p>
<p><img src="https://i.loli.net/2021/01/27/vtYSXkhM8GKAmNy.png" srcset="/img/loading.gif" lazyload alt="image-20210102114309709.png"></p>
<p>建立索引 : </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> index idx_seller_name_status_address <span class="hljs-keyword">on</span> tb_seller(name, status, address);<br></code></pre></td></tr></table></figure>

<h4 id="全值匹配"><a href="#全值匹配" class="headerlink" title="全值匹配"></a>全值匹配</h4><p>对索引中所有列都指定具体值。</p>
<p>该情况下，索引生效，执行效率高。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_seller <span class="hljs-keyword">where</span> name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;小米科技&#x27;</span> <span class="hljs-keyword">and</span> status<span class="hljs-operator">=</span><span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">and</span> address<span class="hljs-operator">=</span><span class="hljs-string">&#x27;北京市&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h4 id="最左前缀法则"><a href="#最左前缀法则" class="headerlink" title=" 最左前缀法则"></a><img src="https://i.loli.net/2021/01/27/5wTQco1LvV7FEan.png" srcset="/img/loading.gif" lazyload alt="image-20210102114412770"> 最左前缀法则</h4><p>如果索引了多列，要遵守最左前缀法则。<strong>指的是查询从索引的最左前列开始，并且不跳过索引中的列</strong>(并非要求索引第一字段必须在第一位,出现即可.)。</p>
<ul>
<li>匹配最左前缀法则，走索引：</li>
</ul>
<p><img src="https://i.loli.net/2021/01/27/ZDN1zF2IC4tJL8l.png" srcset="/img/loading.gif" lazyload alt="image-20210102114537793"></p>
<ul>
<li>违法最左前缀法则 ， 索引失效:</li>
</ul>
<p><img src="https://i.loli.net/2021/01/27/HpVSzP5ctUOxX4C.png" srcset="/img/loading.gif" lazyload alt="image-20210102114555809"></p>
<ul>
<li>如果符合最左前缀法则，但是出现跳跃某一列，只有最左列索引生效：</li>
</ul>
<p><img src="https://i.loli.net/2021/01/27/RcKYmrQLfxqtUDT.png" srcset="/img/loading.gif" lazyload alt="image-20210102114620872"></p>
<h4 id="范围查询右边的列，不能使用索引"><a href="#范围查询右边的列，不能使用索引" class="headerlink" title="范围查询右边的列，不能使用索引"></a>范围查询右边的列，不能使用索引</h4><p><img src="https://i.loli.net/2021/01/27/seBKYAxgf96SnqT.png" srcset="/img/loading.gif" lazyload alt="image-20210102114702779"></p>
<p>根据前面的两个字段name ， status 查询是走索引的， 但是最后一个条件address 没有用到索引。</p>
<h4 id="在索引列上进行运算操作索引将失效"><a href="#在索引列上进行运算操作索引将失效" class="headerlink" title="在索引列上进行运算操作索引将失效"></a>在索引列上进行运算操作索引将失效</h4><p><img src="https://i.loli.net/2021/01/27/uTwAGnFo8iv124D.png" srcset="/img/loading.gif" lazyload alt="image-20210102114742534"></p>
<h4 id="字符串不加单引号造成索引失效"><a href="#字符串不加单引号造成索引失效" class="headerlink" title="字符串不加单引号造成索引失效"></a>字符串不加单引号造成索引失效</h4><p><img src="https://i.loli.net/2021/01/27/TaXJYNcr3SPBGDk.png" srcset="/img/loading.gif" lazyload alt="image-20210102114759976"></p>
<p>由于，在查询时，没有对字符串加单引号，MySQL的查询优化器，会自动的进行类型转换，造成索引失效。</p>
<h4 id="使用or使索引失效"><a href="#使用or使索引失效" class="headerlink" title="使用or使索引失效"></a>使用or使索引失效</h4><p><strong>用or分割开的条件， 如果or前的条件中的列有索引，而后面的列中没有索引，那么涉及的索引都不会被用到。</strong></p>
<p>示例，name字段是索引列 ， 而createtime不是索引列，中间是or进行连接是不走索引的 :</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_seller <span class="hljs-keyword">where</span> name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;黑马程序员&#x27;</span> <span class="hljs-keyword">or</span> createtime <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2088-01-01 12:00:00&#x27;</span>\G;<br></code></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/01/27/kEnMAZFh21TR6q9.png" srcset="/img/loading.gif" lazyload alt="image-20210102114914453"></p>
<h4 id="以-开头的Like模糊查询索引失效"><a href="#以-开头的Like模糊查询索引失效" class="headerlink" title="以%开头的Like模糊查询索引失效"></a>以%开头的Like模糊查询索引失效</h4><p><strong>如果仅仅是尾部模糊匹配，索引不会失效。如果是头部模糊匹配，索引失效。</strong></p>
<p><img src="https://i.loli.net/2021/01/27/5eQYGLuVTdZ3bKJ.png" srcset="/img/loading.gif" lazyload alt="image-20210102114937160"></p>
<ul>
<li><p>解决方案 ：</p>
<p>通过覆盖索引来解决</p>
</li>
</ul>
<p><img src="https://i.loli.net/2021/01/27/RGQ7YvF6mhrwxJo.png" srcset="/img/loading.gif" lazyload alt="image-20210102115000614"></p>
<h4 id="如果MySQL评估使用索引比全表更慢则不使用索引。"><a href="#如果MySQL评估使用索引比全表更慢则不使用索引。" class="headerlink" title="如果MySQL评估使用索引比全表更慢则不使用索引。"></a>如果MySQL评估使用索引比全表更慢则不使用索引。</h4><p><img src="https://i.loli.net/2021/01/27/mnRHa4UgSekjiuG.png" srcset="/img/loading.gif" lazyload alt="image-20210102115253554"></p>
<h4 id="is-NULL-is-NOT-NULL-有时索引失效。"><a href="#is-NULL-is-NOT-NULL-有时索引失效。" class="headerlink" title="is NULL, is NOT NULL 有时索引失效。"></a>is NULL, is NOT NULL 有时索引失效。</h4><p><img src="https://i.loli.net/2021/01/27/8rkhgI94KERP7i6.png" srcset="/img/loading.gif" lazyload alt="image-20210102115311582"></p>
<h4 id="in-not-in-有时索引失效"><a href="#in-not-in-有时索引失效" class="headerlink" title="in , not in 有时索引失效"></a>in , not in 有时索引失效</h4><p><img src="https://i.loli.net/2021/01/27/khUqeCluLPzTGOB.png" srcset="/img/loading.gif" lazyload alt="image-20210102115328409"></p>
<h4 id="尽量使用覆盖索引避免select"><a href="#尽量使用覆盖索引避免select" class="headerlink" title="尽量使用覆盖索引避免select *"></a>尽量使用覆盖索引避免select *</h4><p>尽量使用<strong>覆盖索引</strong>（只访问索引的查询（索引列完全包含查询列）），减少select * 。</p>
<p><img src="https://i.loli.net/2021/01/27/bUs12rNhJeOGVZo.png" srcset="/img/loading.gif" lazyload alt="image-20210102115353112"></p>
<p>如果查询列，超出索引列，也会降低性能。</p>
<blockquote>
<p>TIP :</p>
<p>using index ：使用覆盖索引的时候就会出现 </p>
<p>using where：在查找使用索引的情况下，需要回表去查询所需的数据 </p>
<p>using index condition：查找使用了索引，但是需要回表查询数据 </p>
<p>using index ; using where：查找使用了索引，但是需要的数据都在索引列中能找到，所以不需要回表查询数据 </p>
</blockquote>
<h2 id="4-5-索引设计原则"><a href="#4-5-索引设计原则" class="headerlink" title="4.5 索引设计原则"></a>4.5 索引设计原则</h2><ul>
<li><p>对查询频次较高，且数据量比较大的表建立索引。</p>
</li>
<li><p>索引字段的选择，最佳候选列应当从where子句的条件中提取，如果where子句中的组合比较多，那么应当挑选最常用、过滤效果最好的列的组合。</p>
</li>
<li><p>使用唯一索引，区分度越高，使用索引的效率越高。</p>
</li>
<li><p>索引可以有效的提升查询数据的效率，但索引数量不是多多益善，索引越多，维护索引的代价自然也就水涨船高。对于插入、更新、删除等DML操作比较频繁的表来说，索引过多，会引入相当高的维护代价，降低DML操作的效率，增加相应操作的时间消耗。另外索引过多的话，MySQL也会犯选择困难病，虽然最终仍然会找到一个可用的索引，但无疑提高了选择的代价。</p>
</li>
<li><p>使用短索引，索引创建之后也是使用硬盘来存储的，因此提升索引访问的I&#x2F;O效率，也可以提升总体的访问效率。假如构成索引的字段总长度比较短，那么在给定大小的存储块内可以存储更多的索引值，相应的可以有效的提升MySQL访问索引的I&#x2F;O效率。</p>
</li>
<li><p>利用最左前缀，N个列组合而成的组合索引，那么相当于是创建了N个索引，如果查询时where子句中使用了组成该索引的前几个字段，那么这条查询SQL可以利用组合索引来提升查询效率。</p>
</li>
</ul>
<h1 id="5-常见的SQL优化"><a href="#5-常见的SQL优化" class="headerlink" title="5. 常见的SQL优化"></a>5. 常见的SQL优化</h1><h2 id="5-1-环境准备"><a href="#5-1-环境准备" class="headerlink" title="5.1 环境准备"></a>5.1 环境准备</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `emp` ( <br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT, <br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, `age` <span class="hljs-type">int</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <br>  `salary` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> `emp` (`id`, `name`, `age`, `salary`) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;Tom&#x27;</span>,<span class="hljs-string">&#x27;25&#x27;</span>,<span class="hljs-string">&#x27;2300&#x27;</span>); <br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> `emp` (`id`, `name`, `age`, `salary`) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;Jerry&#x27;</span>,<span class="hljs-string">&#x27;30&#x27;</span>,<span class="hljs-string">&#x27;3500&#x27;</span>); <br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> `emp` (`id`, `name`, `age`, `salary`) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;Luci&#x27;</span>,<span class="hljs-string">&#x27;25&#x27;</span>,<span class="hljs-string">&#x27;2800&#x27;</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> `emp` (`id`, `name`, `age`, `salary`) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;4&#x27;</span>,<span class="hljs-string">&#x27;Jay&#x27;</span>,<span class="hljs-string">&#x27;36&#x27;</span>,<span class="hljs-string">&#x27;3500&#x27;</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> `emp` (`id`, `name`, `age`, `salary`) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;5&#x27;</span>,<span class="hljs-string">&#x27;Tom2&#x27;</span>,<span class="hljs-string">&#x27;21&#x27;</span>,<span class="hljs-string">&#x27;2200&#x27;</span>); <br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> `emp` (`id`, `name`, `age`, `salary`) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;6&#x27;</span>,<span class="hljs-string">&#x27;Jerry2&#x27;</span>,<span class="hljs-string">&#x27;31&#x27;</span>,<span class="hljs-string">&#x27;3300&#x27;</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> `emp` (`id`, `name`, `age`, `salary`) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;7&#x27;</span>,<span class="hljs-string">&#x27;Luci2&#x27;</span>,<span class="hljs-string">&#x27;26&#x27;</span>,<span class="hljs-string">&#x27;2700&#x27;</span>); <br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> `emp` (`id`, `name`, `age`, `salary`) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;8&#x27;</span>,<span class="hljs-string">&#x27;Jay2&#x27;</span>,<span class="hljs-string">&#x27;33&#x27;</span>,<span class="hljs-string">&#x27;3500&#x27;</span>); <br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> `emp` (`id`, `name`, `age`, `salary`) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;9&#x27;</span>,<span class="hljs-string">&#x27;Tom3&#x27;</span>,<span class="hljs-string">&#x27;23&#x27;</span>,<span class="hljs-string">&#x27;2400&#x27;</span>); <br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> `emp` (`id`, `name`, `age`, `salary`) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;10&#x27;</span>,<span class="hljs-string">&#x27;Jerry3&#x27;</span>,<span class="hljs-string">&#x27;32&#x27;</span>,<span class="hljs-string">&#x27;3100&#x27;</span>); <br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> `emp` (`id`, `name`, `age`, `salary`) <span class="hljs-keyword">values</span>(<span class="hljs-string">&#x27;11&#x27;</span>,<span class="hljs-string">&#x27;Luci3&#x27;</span>,<span class="hljs-string">&#x27;26&#x27;</span>,<span class="hljs-string">&#x27;2900&#x27;</span>);<br></code></pre></td></tr></table></figure>

<h2 id="5-2-order-by优化"><a href="#5-2-order-by优化" class="headerlink" title="5.2 order by优化"></a>5.2 order by优化</h2><h3 id="5-2-1-两种排序方式"><a href="#5-2-1-两种排序方式" class="headerlink" title="5.2.1 两种排序方式"></a>5.2.1 两种排序方式</h3><p>1). 第一种是通过对返回数据进行排序，也就是通常说的 filesort 排序，所有不是通过索引直接返回排序结果的排序都叫 FileSort 排序。<img src="https://i.loli.net/2021/01/27/QqZWDExtG1amPj4.png" srcset="/img/loading.gif" lazyload alt="image-20210102115948644"></p>
<p>2). 第二种通过有序索引顺序扫描直接返回有序数据，这种情况即为 using index，不需要额外排序，操作效率高。</p>
<p><img src="https://i.loli.net/2021/01/27/gwpP7O2Y13AWjRx.png" srcset="/img/loading.gif" lazyload alt="image-20210102120019132"></p>
<p>多字段排序</p>
<p><img src="https://i.loli.net/2021/01/27/hZ6bxFES31iHe5U.png" srcset="/img/loading.gif" lazyload alt="image-20210102120101808"></p>
<p>了解了MySQL的排序方式，优化目标就清晰了：尽量减少额外的排序，通过索引直接返回有序数据。</p>
<p>where 条件和Order by 使用相同的索引，并且Order By 的顺序和索引顺序相同， 并且Order by 的字段都是升序，或者都是降序。否则肯定需要额外的操作，这样就会出现FileSort。</p>
<h3 id="5-2-2-Filesort-的优化"><a href="#5-2-2-Filesort-的优化" class="headerlink" title="5.2.2 Filesort 的优化"></a>5.2.2 Filesort 的优化</h3><p>通过创建合适的索引，能够减少 Filesort 的出现，但是在某些情况下，条件限制不能让Filesort消失，那就需要加快 Filesort的排序操作。对于Filesort ， MySQL 现在采用的是一次扫描算法：一次性取出满足条件的所有字段，然后在排序区 sort buffer 中排序后直接输出结果集。排序时内存开销较大，但是排序效率比两次扫描算法要高。</p>
<p>MySQL 通过比较系统变量 max_length_for_sort_data 的大小和Query语句取出的字段总大小， 来判定是否那种排序算法，如果max_length_for_sort_data 更大，那么使用第二种优化之后的算法；否则使用第一种。</p>
<p>可以适当提高 sort_buffer_size 和 max_length_for_sort_data 系统变量，来增大排序区的大小，提高排序的效率。</p>
<p><img src="https://i.loli.net/2021/01/27/W3iZJFjywgxD5vq.png" srcset="/img/loading.gif" lazyload alt="image-20210102120229796"></p>
<h2 id="5-3-group-by优化"><a href="#5-3-group-by优化" class="headerlink" title="5.3 group by优化"></a>5.3 group by优化</h2><p>由于GROUP BY 实际上也同样会进行排序操作，而且与ORDER BY 相比，GROUP BY 主要只是多了排序之后的分组操作。当然，如果在分组的时候还使用了其他的一些聚合函数，那么还需要一些聚合函数的计算。所以，在GROUP BY 的实现过程中，与 ORDER BY 一样也可以利用到索引。</p>
<p>如果查询包含 group by 但是用户想要避免排序结果的消耗， 则可以执行order by null 禁止排序。如下 ：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> age,<span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> age;<br></code></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/01/27/nE1w9LgHGBcK2x3.png" srcset="/img/loading.gif" lazyload alt="image-20210102120357530"></p>
<p>优化后:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">explain <span class="hljs-keyword">select</span> age,<span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> age <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">null</span>;<br></code></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/01/27/BPMWOQzAGDK7U3L.png" srcset="/img/loading.gif" lazyload alt="image-20210102120425871"></p>
<p>从上面的例子可以看出，第一个SQL语句需要进行”filesort”，而第二个SQL由于order by null 不需要进行 “filesort”， 而上文提过Filesort往往非常耗费时间。</p>
<p>创建索引 ： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> index idx_emp_age_salary <span class="hljs-keyword">on</span> emp(age,salary);<br></code></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/01/27/r4kIxJOpmMygEuc.png" srcset="/img/loading.gif" lazyload alt="image-20210102120521652"></p>
<h2 id="5-4-limit优化"><a href="#5-4-limit优化" class="headerlink" title="5.4 limit优化"></a>5.4 limit优化</h2><p>limit分页操作, 越往后, 性能越低 :</p>
<p>优化方案: </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> tb_sku t , (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> tb_sku <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id limit <span class="hljs-number">9000000</span>,<span class="hljs-number">1</span>) a <span class="hljs-keyword">where</span> t.id <span class="hljs-operator">=</span> a.id;<br></code></pre></td></tr></table></figure>

<h2 id="5-5-count优化"><a href="#5-5-count优化" class="headerlink" title="5.5 count优化"></a>5.5 count优化</h2><p>在很多的业务系统中，都需要考虑进行分页操作，但是当我们执行分页操作时，都需要进行一次count操作，求取总记录数，如果数据库表的数据量大，在InnoDB引擎中，执行count操作的性能是比较低的，需要遍历全表数据，对计数进行累加。</p>
<p>优化方案：</p>
<p>①. 在大数据量的查询中，只查询数据， 而不展示总记录数 ； </p>
<p>②. 通过缓存redis维护一个表的计数，来记录数据库表的总记录数，在执行插入&#x2F;删除时，需要动态更新；</p>
<p>③. 在数据库表中定义一个大数据量的计数表，在执行插入&#x2F;删除时，需要动态更新。</p>
<p>弊端:无法满足各种带where条件的count查询.</p>
<h2 id="5-6-大批量插入优化"><a href="#5-6-大批量插入优化" class="headerlink" title="5.6 大批量插入优化"></a>5.6 大批量插入优化</h2><p>使用load命令!</p>
<p>环境准备:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tb_user` (<br>  `id` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT, <br>  `username` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <br>  `password` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <br>  `name` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <br>  `birthday` <span class="hljs-type">DATE</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `sex` <span class="hljs-type">CHAR</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>, <br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`), <br>  <span class="hljs-keyword">UNIQUE</span> KEY `unique_user_username` (`username`)<br>) ENGINE<span class="hljs-operator">=</span>INNODB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8 ;<br></code></pre></td></tr></table></figure>

<p>Load使用:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- fields terminated by &#x27;,&#x27; lines terminated by &#x27;\n&#x27;可自定义别的符号.</span><br>load data <span class="hljs-keyword">local</span> infile <span class="hljs-string">&#x27;/root/sql1.log&#x27;</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> `tb_user` fields terminated <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;,&#x27;</span> lines terminated <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;\n&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h3 id="5-6-1-对于-InnoDB-类型的表，有以下几种方式可以提高导入的效率："><a href="#5-6-1-对于-InnoDB-类型的表，有以下几种方式可以提高导入的效率：" class="headerlink" title="5.6.1 对于 InnoDB 类型的表，有以下几种方式可以提高导入的效率："></a>5.6.1 对于 InnoDB 类型的表，有以下几种方式可以提高导入的效率：</h3><h3 id="1）-主键顺序插入"><a href="#1）-主键顺序插入" class="headerlink" title="1） 主键顺序插入"></a>1） 主键顺序插入</h3><p>因为InnoDB类型的表是按照主键的顺序保存的，所以将导入的数据按照主键的顺序排列，可以有效的提高导入数据的效率。如果InnoDB表没有主键，那么系统会自动默认创建一个内部列作为主键，所以如果可以给表创建一个主键，将可以利用这点，来提高导入数据的效率。</p>
<p><img src="https://i.loli.net/2021/01/27/DXFIvx3KHBpLlOq.png" srcset="/img/loading.gif" lazyload alt="image-20210102121542033"></p>
<h5 id="2）-关闭唯一性校验"><a href="#2）-关闭唯一性校验" class="headerlink" title="2） 关闭唯一性校验"></a><img src="https://i.loli.net/2021/01/27/6aDBX3nVytQCP4z.png" srcset="/img/loading.gif" lazyload alt="image-20210102121518728">2） 关闭唯一性校验</h5><p>在导入数据前执行 SET UNIQUE_CHECKS&#x3D;0，关闭唯一性校验，在导入结束后执行 SET UNIQUE_CHECKS&#x3D;1，恢复唯一性校验，可以提高导入的效率。</p>
<h5 id="3）-手动提交事务"><a href="#3）-手动提交事务" class="headerlink" title="3） 手动提交事务"></a><img src="https://i.loli.net/2021/01/27/l8DwIRpVJnSi2Ft.png" srcset="/img/loading.gif" lazyload alt="image-20210102121608494">3） 手动提交事务</h5><p>如果应用使用自动提交的方式，建议在导入前执行 SET AUTOCOMMIT&#x3D;0，关闭自动提交，导入结束后再执行 SET AUTOCOMMIT&#x3D;1，打开自动提交，也可以提高导入的效率。</p>
<p><img src="https://i.loli.net/2021/01/27/xEo8Tbgqv46SFMY.png" srcset="/img/loading.gif" lazyload alt="image-20210102121630297"></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="category-chain-item">数据库</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/sql-java/" class="print-no-link">#sql - java</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>SQL语句性能提升</div>
      <div>http://www.lifeab.com/2021/01/02/SQL优化/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Wick</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2021年1月2日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/01/26/%E7%BC%96%E5%86%99%E4%BC%98%E9%9B%85%E9%AB%98%E6%95%88%E7%9A%84java%E4%BB%A3%E7%A0%81/" title="编写高效优雅java代码">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">编写高效优雅java代码</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/12/04/Hexo%E6%90%AD%E5%BB%BA%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2/" title="hexo搭建静态博客">
                        <span class="hidden-mobile">hexo搭建静态博客</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
