

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Wick">
  <meta name="keywords" content="">
  
    <meta name="description" content="redis五种数据类型,持久化,事务,通用命令等.">
<meta property="og:type" content="article">
<meta property="og:title" content="redis">
<meta property="og:url" content="http://www.lifeab.com/2021/01/23/redis/index.html">
<meta property="og:site_name" content="我的博客">
<meta property="og:description" content="redis五种数据类型,持久化,事务,通用命令等.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/01/30/oxvBH9EgWXTjSGA.png">
<meta property="og:image" content="https://i.loli.net/2021/01/30/iIGRsyC3n6l9w24.png">
<meta property="og:image" content="https://i.loli.net/2021/01/30/daySTQE9livjgXJ.png">
<meta property="og:image" content="https://i.loli.net/2021/01/30/sLbq7CDHG39WI1A.png">
<meta property="article:published_time" content="2021-01-23T15:10:17.000Z">
<meta property="article:modified_time" content="2024-07-12T07:49:58.937Z">
<meta property="article:author" content="John Wick">
<meta property="article:tag" content="redis">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://i.loli.net/2021/01/30/oxvBH9EgWXTjSGA.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>redis - 我的博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.lifeab.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":4},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Freedom is as important as breathing</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="redis"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-01-23 23:10" pubdate>
          2021年1月23日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.2k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          61 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">redis</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">安装gcc环境</span><br>yum install gcc-c++<br>wget http://download.redis.io/releases/redis-3.2.8.tar.gz<br><span class="hljs-meta prompt_">#</span><span class="language-bash">1.下载安装包 6.0.5版本</span><br>wget http://download.redis.io/releases/redis-6.0.5.tar.gz<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">2.解压到指定文件夹</span><br>mkdir -p /usr/local/redis<br>tar -zxvf redis-6.0.5.tar.gz -C /usr/local/redis/<br><span class="hljs-meta prompt_">#</span><span class="language-bash">3.在编译安装前，查看系统gcc环境的版本（gcc -v），centos7默认安装的版本为4.8.5，该版本过低会无法进行安装，需要升级gcc到6以上。</span><br>sudo yum -y install centos-release-scl<br>sudo yum -y install devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutils<br>sudo scl enable devtoolset-9 bash<br>sudo echo &quot;source /opt/rh/devtoolset-9/enable&quot; &gt;&gt; /etc/profile<br>gcc -v<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">4.进入文件夹 编译</span><br>cd /usr/local/redis/redis-6.0.5/<br>make<br><span class="hljs-meta prompt_">#</span><span class="language-bash">编译并安装到指定文件夹</span><br>sudo make &amp;&amp; sudo make install PREFIX=/usr/local/redis/redis-6.0.5<br><span class="hljs-meta prompt_">#</span><span class="language-bash">若编译报错:zmalloc.h:50:10: fatal error: jemalloc/jemalloc.h: No such file or directory</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">则使用命令:make MALLOC=libc</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">5.修改redis.conf的一些必要配置：</span><br>daemonize no --&gt; yes  # 让redis启动的时候以后台服务的形式<br>requirepass foobared --&gt; #设置redis的连接密码<br>port 6379　　　　--&gt; #redis的启动端口，默认为6379<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">6.将redis做成服务，并设置成开机启动：</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">7.指定redis日志和数据存放目录</span><br>mkdir -p /usr/local/redis/redis-6.0.5/log<br>mkdir -p /usr/local/redis/redis-6.0.5/data<br>vim redis.conf<br><span class="hljs-meta prompt_"># </span><span class="language-bash">指定redis日志文件存放目录</span><br>logfile &quot;/usr/local/redis/redis-6.0.5/log/redis.log&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">指定redis数据存放目录</span><br>dir /usr/local/redis/redis-6.0.5/data<br></code></pre></td></tr></table></figure>



<h1 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>C语言开发,依赖gcc环境.</p>
<p>客户端启动会默认连接本机6379端口.</p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点:"></a>特点:</h2><ul>
<li>高效性.Redis读取的速度是110000次&#x2F;s,写的速度是81000次&#x2F;s</li>
<li>原子性. Redis的所有操作都是原子性的,同时Redis还支持对几个操作全并后的原子性执行。</li>
<li>稳定性:持久化,主外复制(集群) .</li>
<li>其他特性:支持过期时间,支持事务,消息订阅。</li>
</ul>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><ul>
<li><code>reids</code>默认有<code>16</code>个数据库,命名是<code>0 , 1 , 2 ....15</code>,默认使用<code>0</code>号数据库,切换数据库使用命令<code>select 2</code>.</li>
<li>移动数据到别的库:<code>move key 2</code>: 表示把key移到2库.</li>
<li>清空当前数据库:<code>flushdb</code></li>
<li>清空redis服务器:<code>flushall</code></li>
<li>退出客户端:<code>quit</code>或<code>ctrl c</code></li>
<li>查询当前数据库中<code>key</code>的数量:<code>dbsize</code></li>
<li>查看当前<code>redis</code>信息:<code>info</code></li>
<li>启动服务端 前端启动(无法部署集群) <code>./redis/bin/redis-server</code></li>
<li>后端启动<ul>
<li>修改redis.conf文件,开启守护线程: daemonize yes</li>
<li><code>./bin/redis-server ./redis.conf</code></li>
</ul>
</li>
<li>启动客户端 默认连接本地6379端口 <code>./redis/bin/redis-cli</code></li>
<li>连接其他机器 <code>./bin/redis-cli -h ip -p 6379</code></li>
<li>关闭redis <code>kill -9 进程号</code> 或 <code>./bin/redis-cli shutdown</code></li>
<li>查询所有key  *表示0或多个 ?表示1个<code>keys *</code></li>
<li>查询长度为4的key <code>keys ????</code></li>
<li>模糊查询 查询带name的key <code>keys *name*</code></li>
<li>删除key 删除多个key <code>del key [key2 key3...]</code></li>
<li>判断key是否存在 存在返回1否则返回0 <code>exists key</code></li>
<li>重命名key 不常用 <code>rname oldkey newkey</code></li>
<li>返回key的value的数据类型 <code>type key</code></li>
<li>设置key过期时间30秒,单位是秒,默认永久有效 <code>expire key 30</code></li>
<li>查询key剩余有效期时间,-2表示过期,会删除key.若未设置超时返回-1 <code>ttl key</code></li>
</ul>
<h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><blockquote>
<p><code>key</code>都是字符串类型,<code>value</code>分为五种数据类型:<code>String</code>,<code>hash</code>,<code>list</code>,<code>set</code>,<code>有序set</code></p>
</blockquote>
<h2 id="String"><a href="#String" class="headerlink" title="String"></a>String</h2><blockquote>
<p>单个值最大512M,对应<code>java</code>中的<code>map</code></p>
</blockquote>
<h3 id="使用命令"><a href="#使用命令" class="headerlink" title="使用命令"></a>使用命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">set key value<br>get key<br>del key<br>getset key value<br>incr key<br>decr key<br>append key<br>incrby <br>decrby <br></code></pre></td></tr></table></figure>

<h2 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h2><blockquote>
<p>示例:{username:”zhangsan”,age:”18”},类似<code>JSON</code>,对应<code>java</code>中的<code>bean</code>.</p>
</blockquote>
<h3 id="使用命令-1"><a href="#使用命令-1" class="headerlink" title="使用命令"></a>使用命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">赋值</span><br>hset key field value<br><span class="hljs-meta prompt_">#</span><span class="language-bash">赋值多个</span><br>hmset key field value[field1 value1 field2 value2...]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">取值</span><br>hget key field<br><span class="hljs-meta prompt_">#</span><span class="language-bash">取值多个</span><br>hmget key field1 field2...<br><span class="hljs-meta prompt_">#</span><span class="language-bash">取值全部</span><br>hgetall key<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询key有几个field</span><br>hlen key<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询<span class="hljs-built_in">hash</span>所有field</span><br>hkeys key<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询<span class="hljs-built_in">hash</span>所有value</span><br>hvals key<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除</span><br>hdel key field [field2 field3...]<br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除整个<span class="hljs-built_in">hash</span></span><br>del key<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">增加值</span><br>hincrby key field 10<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">判断field的value是否存在,存在返回1,否则返回0</span><br>hexists key field<br></code></pre></td></tr></table></figure>

<h2 id="list"><a href="#list" class="headerlink" title="list"></a>list</h2><blockquote>
<p>示例:[1,2,3],对应linkedList链表集合,增删快.</p>
<p>redis中是双向链表,增删极快.</p>
</blockquote>
<h3 id="场景"><a href="#场景" class="headerlink" title="场景:"></a>场景:</h3><p>​	大数据量集合操作,任务队列</p>
<h3 id="使用命令-2"><a href="#使用命令-2" class="headerlink" title="使用命令"></a>使用命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">左赋值</span><br>lpush key a b c d <br><span class="hljs-meta prompt_">#</span><span class="language-bash">右赋值 符合习惯</span><br>rpush key a b c d<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">取值,获取list中start到end的值.</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">start end 从0开始,可为负数,-1表示尾部元素,-2表示倒数第二个元素...</span><br>lrange key start end<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询list长度</span><br>llen key<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除左边第一个元素,若key不存在返回nil,存在返回第一个元素</span><br>lpop key<br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除右边最后一个元素</span><br>rpop key<br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除集合中所有a,若0改为2表示左边开始删2个,-2表示右边开始删2个   效率极低,因为需要给集合赋索引操作</span><br>lrem key 0 a<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在pivot元素前|后插入value  效率不高</span><br>linsert kry before|after pivot value<br><span class="hljs-meta prompt_">#</span><span class="language-bash">替换下标为index的元素为value 效率不高</span><br>lset key index value<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">将集合中尾部元素弹出,添加到头部,存入新集合list2 通过循环实现队列功能</span><br>rpoplpush list1 list2<br><span class="hljs-meta prompt_">#</span><span class="language-bash">eg: list1为 a b c ,执行一次后:list1: a b list2:c</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">循环队列</span><br>rpoplpush list1 list1<br></code></pre></td></tr></table></figure>

<h2 id="set"><a href="#set" class="headerlink" title="set"></a>set</h2><blockquote>
<p>对应hashset,无序,不重复.</p>
</blockquote>
<h3 id="场景-1"><a href="#场景-1" class="headerlink" title="场景:"></a>场景:</h3><p>​	redis中涉及到两个集合的交集 并集 差集运算.</p>
<h3 id="使用命令-3"><a href="#使用命令-3" class="headerlink" title="使用命令"></a>使用命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">赋值,重复的会去除</span><br>sadd key a b c d d<br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除元素</span><br>srem key a b<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询所有元素</span><br>smembers key<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询a元素是否存在,存在返回1,否则返回0</span><br>sismember key a<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询<span class="hljs-built_in">set</span>中元素数量</span><br>scard key<br><span class="hljs-meta prompt_">#</span><span class="language-bash">随机返回<span class="hljs-built_in">set</span>中一个元素 伪随机</span><br>srandmember key<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">差集运算,属于key1 不属于key2</span><br>sdiff key1 key2<br><span class="hljs-meta prompt_">#</span><span class="language-bash">交集运算</span><br>sinter key1 key2<br><span class="hljs-meta prompt_">#</span><span class="language-bash">并集运算</span><br>sunion key1 key2<br><span class="hljs-meta prompt_">#</span><span class="language-bash">将差|并|交集存入新的set3中</span><br>sdiffstore|sunionstore|sinterstore set3 set1 set2<br></code></pre></td></tr></table></figure>

<h2 id="有序set"><a href="#有序set" class="headerlink" title="有序set"></a>有序set</h2><blockquote>
<p>有序,不重复.</p>
<p>默认升序</p>
</blockquote>
<h3 id="场景-2"><a href="#场景-2" class="headerlink" title="场景:"></a>场景:</h3><p>​	排行榜 </p>
<h3 id="使用命令-4"><a href="#使用命令-4" class="headerlink" title="使用命令"></a>使用命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">赋值</span> <br>zadd set1 500 xiaoming 200 xiaohong 100 xiaogang<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询xiaoming的分数</span><br>zscore set1 xiaoming<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询元素数量</span><br>zcard set1<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询所有元素</span><br>zrange set1 0 -1<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询所有元素的分数</span><br>zrange set1 0 -1 withscores<br><span class="hljs-meta prompt_">#</span><span class="language-bash">倒序查看所有元素 --&gt;排行榜</span><br>zrevrange set1 0 -1 withscores<br><span class="hljs-meta prompt_">#</span><span class="language-bash">按分数范围查询元素. 后可加withscores显示分数.后可加<span class="hljs-built_in">limit</span> 0 1查询前两名</span><br>zrangebyscore set1 200 500<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询指定分数范围内有几个元素</span><br>zcount set1 200 1000<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询xiaoming在set1中的排名 从小到大</span><br>zrank set1 xiaoming<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询xiaoming在set1中的排名 从大到小</span><br>zrevrank set1 xiaoming<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除元素</span><br>zrem set1 xiaoming xiaohong<br><span class="hljs-meta prompt_">#</span><span class="language-bash">范围删除 删除前两名</span><br>zremrangebyscore set1 0 1<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">加值 给xiaoming加200分</span><br>zincrby set1 200 xiaoming<br><br></code></pre></td></tr></table></figure>

<h1 id="redis通用命令"><a href="#redis通用命令" class="headerlink" title="redis通用命令"></a>redis通用命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查询所有key  *表示0或多个 ?表示1个</span><br>keys *<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询长度为4的key</span><br>keys ????<br><span class="hljs-meta prompt_">#</span><span class="language-bash">模糊查询 查询带name的key</span><br>keys *name*<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除key 删除多个key</span><br>del key [key2 key3...]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">判断key是否存在 存在返回1否则返回0</span><br>exists key<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">重命名key 不常用</span><br>rname oldkey newkey<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">返回key的value的数据类型</span><br>type key<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">设置key过期时间30秒,单位是秒,默认永久有效</span><br>expire key 30<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询key剩余有效期时间,-2表示过期,会删除key.若未设置超时返回-1</span><br>ttl key<br></code></pre></td></tr></table></figure>

<h1 id="redis事务"><a href="#redis事务" class="headerlink" title="redis事务"></a>redis事务</h1><blockquote>
<p>redis事务不是为了保证数据完整性,而是为了服务于批量操作.</p>
<p>事务中报错并不会回滚,而是正常顺序执行.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">开启事务</span><br>multi<br><span class="hljs-meta prompt_">#</span><span class="language-bash">提交事务</span><br>exec<br><span class="hljs-meta prompt_">#</span><span class="language-bash">回滚事务</span><br>discard<br></code></pre></td></tr></table></figure>

<h1 id="redis持久化"><a href="#redis持久化" class="headerlink" title="redis持久化"></a>redis持久化</h1><blockquote>
<p>redis默认所有增删改都是在内存中执行,因此提供了两种持久化策略</p>
</blockquote>
<ul>
<li><p>RDB</p>
<blockquote>
<p>默认策略.</p>
<p>相当于是照快照,保存的是一种状态,占用空间小.</p>
<p>符合要求时会随时启动保存操作,占用系统资源(内存),适合内存充裕的服务器.</p>
<p>大公司一般使用RDB策略.</p>
</blockquote>
<blockquote>
<p>持久化操作何时进行?</p>
<ul>
<li><p>服务器正常关闭时 .&#x2F;bin&#x2F;redis-cli shutdown</p>
</li>
<li><p>满足一定条件时.在redis.conf中可配置,但一般默认的即是最优配置.</p>
<p>默认配置如下:</p>
<p>Save 900 1       –&gt;每900秒(15分钟)有一个key变化,则照快照.</p>
<p>save 300 10     –&gt;每300秒(5分钟)有10个key变化,则照快照.</p>
<p>save 60 10000 –&gt;每60秒(1分钟)有10000个key变化,则照快照.</p>
</li>
</ul>
</blockquote>
</li>
<li><p>AOF</p>
<blockquote>
<ul>
<li><p>默认关闭.</p>
</li>
<li><p>原理:使用日志功能保存数据,aof只会保存导致key变化的命令.</p>
</li>
<li><p>优点:占用内存小;缺点:日志文件大,不适合灾备;恢复效率低.</p>
</li>
<li><p>适用内存小的服务器.</p>
</li>
<li><p>三种机制:</p>
<ul>
<li>everysec 每秒同步</li>
<li>always     每次修改同步</li>
<li>no             不同步(默认)</li>
</ul>
</li>
<li><p>配置:</p>
<ul>
<li><p>修改redis.conf文件:</p>
<p>Appendonly yes :开启aof</p>
<p>appendfsync always:选择策略</p>
<p>重启redis</p>
</li>
</ul>
</li>
</ul>
</blockquote>
</li>
</ul>
<h1 id="Jedis"><a href="#Jedis" class="headerlink" title="Jedis"></a>Jedis</h1><blockquote>
<p>jedis是java连接操作redis的框架.</p>
<p>redis有什么命令,jedis就有对应的方法.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//单实例使用示例</span><br><span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.0.20&quot;</span>,<span class="hljs-number">6379</span>);<br><br><br><span class="hljs-comment">//连接池</span><br><span class="hljs-type">JedisPoolConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPoolConfig</span>();<br>config.setMaxTotal(<span class="hljs-number">50</span>);<span class="hljs-comment">//池中最大连接数</span><br>config.setMaxIdle(<span class="hljs-number">10</span>);<span class="hljs-comment">//池中空闲时保留的最大连接数</span><br><span class="hljs-type">JedisPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPool</span>(config,<span class="hljs-string">&quot;192.168.0.20&quot;</span>,<span class="hljs-number">6379</span>);<br><span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> pool.getResource();<br>jedis.getName(<span class="hljs-string">&quot;username&quot;</span>);<br>jedis.close();<span class="hljs-comment">//连接归还池中.</span><br></code></pre></td></tr></table></figure>

<h1 id="过期策略"><a href="#过期策略" class="headerlink" title="过期策略"></a>过期策略</h1><p>过期策略通常有以下三种:</p>
<ul>
<li><p><strong>定时过期</strong><br>每个设置过期时间的key都需要创建一个定时器,到过期时间就会立即清除。该策略可以立即清除过期的数据,<strong>对内存很友好;但是会占用大量的CPU资源去处理过期的数据</strong>,从而影响缓存的响应时间和吞吐量。</p>
</li>
<li><p><strong>惰性过期.</strong><br>只有当访问一个key时,才会判断该key是否已过期,过期则清除。<strong>该策略可以最大化地节省CPU资源,却对内存非常不友好</strong>。极端情况可能出现大量的过期key没有再次被访问,从而不会被清除,占用大量内存。</p>
</li>
<li><p><strong>定期过期</strong><br>每隔一定的时间,会扫描一定数量的数据库的expires字典中一定数量的key,并清除其中已过期的key。<strong>该策略是前两者的一个折中方案</strong>。通过调整定时扫描的时间间隔和每次扫描的限定耗时,可以在不同情况下使得CPU和内存资源达到最优的平衡效果。.</p>
</li>
</ul>
<h1 id="内存淘汰策略"><a href="#内存淘汰策略" class="headerlink" title="内存淘汰策略"></a>内存淘汰策略</h1><p>Redis的内存淘汰策略是指在Redis的用于缓存的内存不足时,怎么处理需要新写入且需要申请额外空间的数据.</p>
<p><strong>实际项目中设置内存淘汰策略: maxmemory-policy allkey-lru,移除最近最少使用的key.</strong></p>
<p><strong>过期策略默认是: maxmemory-policy noeviction</strong></p>
<p>redis.conf配置如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">MAXMEMORY POLICY: how Redis will <span class="hljs-keyword">select</span> what to remove when maxmemory</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">is reached. You can <span class="hljs-keyword">select</span> one from the following behaviors:</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">最大内存策略:当到达最大使用内存时,你可以在下面5种行为中选择, Redis如何选择淘汰数据库键 当内存不足以容纳新写入数据时</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">volatile-lru -&gt; Evict using approximated LRU, only keys with an expire <span class="hljs-built_in">set</span>.</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在设置了过期时间的键空间中,移除最近最少使用的key,这种情况一般是把redis既当缓存，又做持久化存储的时候才用。</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">allkeys-lru -&gt; Evict any key using approximated LRU.</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">移除最近最少使用的key (推荐)</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">volatile-lfu -&gt; Evict using approximated LFU, only keys with an expire <span class="hljs-built_in">set</span>.</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">allkeys-lfu -&gt; Evict any key using approximated LFU.</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">volatile-random -&gt; Remove a random key having an expire <span class="hljs-built_in">set</span>.</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在设置了过期时间的键空间中，随机移除一个键，不推荐</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">allkeys-random -&gt; Remove a random key, any key.</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">直接在键空间中随机移除一个键,弄啥叻</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">volatile-ttl -&gt; Remove the key with the nearest expire time (minor TTL)</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在设置了过期时间的键空间中,有更早过期时间的key优先移除不推荐</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">noeviction -&gt; Don<span class="hljs-string">&#x27;t evict anything, just return an error on write operations.</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-string">不做过键处理,只返回一个写操作错误。不推荐</span></span><br></code></pre></td></tr></table></figure>



<h1 id="Redis的主从复制架构"><a href="#Redis的主从复制架构" class="headerlink" title="Redis的主从复制架构."></a>Redis的主从复制架构.</h1><blockquote>
<p>主从复制,是指将一台Redis服务器的数据,复制到其他的Redis服务器。前者称为主节点(master),后者称为从节点(slave),<strong>数据的复制是单向的,只能由主节点到从节点。</strong></p>
<p>默认情况下,每台Redis服务器都是主节点;且一个主节点可以有多个从节点(或没有从节点),但一个从节点只能有一个主节点。</p>
</blockquote>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ol>
<li>当从数据库启动后,会向主数据库发送SYNC命令</li>
<li>主数据库接收到SYNC命令后开始在后台保存快照(RDB持久化) ,并将保存快照期间接收到的命令缓存进来.</li>
<li>快照完成后, Redis (Master)将快照文件和所有缓存的命令发送给从数据库</li>
<li>Redis (Slave)接收到RDB和缓存命令时,会开始载入快照文件并执行接收到的缓存的命令</li>
<li>后续,每当主数据库接收到写命令时,就会将命令同步给从数据库。所以3和4只会在初始化的时候执行</li>
</ol>
<h2 id="场景-3"><a href="#场景-3" class="headerlink" title="场景"></a>场景</h2><ol>
<li>备份容错(如果只有一个节点,会存在单点故障问题)</li>
<li>读写分离(读多写少的场景很适用) ,如果写操作很多,就得使用集群</li>
<li>从数据库持久化(可以将持久化的性能消耗移动到从节点)</li>
</ol>
<h2 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">修改从节点的配置文件redis.conf</span><br>vim redis.conf<br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改		主节点ip		主节点port</span><br>slaveof masterip masterport<br></code></pre></td></tr></table></figure>

<h1 id="哨兵"><a href="#哨兵" class="headerlink" title="哨兵"></a>哨兵</h1><blockquote>
<p><strong>Sentinel (哨兵)是Redis的高可用性解决方案</strong>:由一个或多个Sentinel实例组成的Sentinel系统可以监视任意多个主服务器,以及这些主服务器属下的所有从服务器,并<strong>在被监视的主服务器进入下线状态时,自动将下线主服务器属下的某个从服务器升级为新的主服务器</strong>。</p>
</blockquote>
<h2 id="配置哨兵"><a href="#配置哨兵" class="headerlink" title="配置哨兵"></a>配置哨兵</h2><blockquote>
<p>每台服务器都要修改sentinel.conf文件配置哨兵.</p>
<p>一般哨兵的配置节点数不能是1个,最好是有几个主从节点,就配置几个哨兵。不能哨兵自己出现单点故障</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">1 修改主节点配置文件</span><br>vim sentinel.conf<br><span class="hljs-meta prompt_">#</span><span class="language-bash">15行 每台机器修改为自己对应的主机各</span><br>bind 127.0.0.1 192.168.1.1<br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改后台运行</span><br>daemonize yes<br><span class="hljs-meta prompt_">#</span><span class="language-bash">三台机器监控的主节点</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">	monitor监控,master-name服务器名称可自定义,ip服务器ip,quorum为2时2代表只有两个或两个以上的哨兵认为主服务器不可用的时候,才会进行failover操作。</span>			<br>sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果Redis是有密码的,需要指定密码</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">定义服务的密码, mymaster服务名称, 123456是Redis服务器密码</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">2 把配置文件复制到其他节点服务器</span><br>scp sentinel.conf 从节点1ip:$PWD<br>scp sentinel.conf 从节点2ip:$PWD<br><span class="hljs-meta prompt_">#</span><span class="language-bash">分别修改从节点配置文件,绑定自己机器的ip</span><br>bind 从节点1ip<br>bind 从节点2ip<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">3 每台服务器启动哨兵服务</span><br>bin/redis-sentinel sentinel.conf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">4 验证哨兵启动是否成功</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看Sentinel master的状态 连接哨兵 26379是哨兵端口</span><br>bin/redis-cli -h 从节点2ip -p 263794<br><span class="hljs-meta prompt_">#</span><span class="language-bash">使用ping命令检查哨兵是否工作,如果正常会返回PONG</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">使用命令info,可以查看主节点有几个从节点,及几个哨兵.</span><br></code></pre></td></tr></table></figure>

<h2 id="哨兵模式下的代码连接"><a href="#哨兵模式下的代码连接" class="headerlink" title="哨兵模式下的代码连接"></a>哨兵模式下的代码连接</h2><blockquote>
<p>哨兵模式下,代码中就不能配置主节点连接信息,因为主节点可能挂掉,所以应该配置哨兵的连接信息,并使用JedisSentinelPool来创建连接池。</p>
</blockquote>
<h1 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h1><h2 id="docker搭建redis集群"><a href="#docker搭建redis集群" class="headerlink" title="docker搭建redis集群"></a>docker搭建redis集群</h2><h3 id="创建模板及脚本"><a href="#创建模板及脚本" class="headerlink" title="创建模板及脚本"></a>创建模板及脚本</h3><blockquote>
<p>在&#x2F;usr&#x2F;local&#x2F;server&#x2F;redis-cluster&#x2F;目录下创建一个模板,把可变参数传入;</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">集群各节点公共配置模板</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">端口</span> <br>port $&#123;PORT&#125; <br><span class="hljs-meta prompt_">#</span><span class="language-bash">非保护模式 若开启则每次都需输入密码</span> <br>protected-mode no <br><span class="hljs-meta prompt_">#</span><span class="language-bash">启用集群模式</span> <br>cluster-enabled yes c<br>luster-config-file nodes.conf <br><span class="hljs-meta prompt_">#</span><span class="language-bash">超时时间</span> <br>cluster-node-timeout 5000 <br><span class="hljs-meta prompt_">#</span><span class="language-bash">集群各节点IP地址</span> <br>cluster-announce-ip 192.168.2.110<br><span class="hljs-meta prompt_">#</span><span class="language-bash">集群节点映射端口</span> <br>cluster-announce-port $&#123;PORT&#125; <br><span class="hljs-meta prompt_">#</span><span class="language-bash">集群总线端口</span> <br>cluster-announce-bus-port 1$&#123;PORT&#125; <br><span class="hljs-meta prompt_">#</span><span class="language-bash">开启aof持久化策略</span> <br>appendonly yes <br><span class="hljs-meta prompt_">#</span><span class="language-bash">后台运行</span> <br><span class="hljs-meta prompt_">#</span><span class="language-bash">daemonize <span class="hljs-built_in">yes</span></span> <br><span class="hljs-meta prompt_">#</span><span class="language-bash">进程号存储</span> <br>pidfile /var/run/redis_$&#123;PORT&#125;.pid <br><span class="hljs-meta prompt_">#</span><span class="language-bash">集群加密</span> <br><span class="hljs-meta prompt_">#</span><span class="language-bash">masterauth itheima</span> <br><span class="hljs-meta prompt_">#</span><span class="language-bash">requirepass itheima</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>创建redis创建容器脚本:</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在/usr/local/server/redis-cluster下生成conf和data目标，并生成配置信息</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">输入信息</span><br>read -p &quot;请输入本机IP地址：&quot; Native_IP<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建文件夹</span><br>mkdir -p /usr/local/server/redis-cluster<br><span class="hljs-meta prompt_"># </span><span class="language-bash">下载redis配置模板</span><br>echo &quot;正在下载redis-cluster.tmpl配置模板，请手动下载redis-cluster.tmpl文件并复制到/usr/local/server/redis-cluster目录&quot;;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">文件下载地址 请手动下载redis-cluster.tmpl文件</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">wget -P /usr/local/server/redis-cluster https://srv-file22.gofile.io/download/RoGvVk/redis-cluster.tmpl</span><br><br>echo &quot;正在创建redis-net网络&quot;;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">c创建网络</span><br>docker network create redis-net<br><br>echo &quot;正在创建redis配置文件&quot;;<br>for port in `seq 7001 7006`; <br>do <br>  mkdir -p /usr/local/server/redis-cluster/$&#123;port&#125;/conf &amp;&amp; PORT=$&#123;port&#125; Native_IP=$&#123;Native_IP&#125;  envsubst &lt; /usr/local/server/redis-cluster/redis-cluster.tmpl &gt; /usr/local/server/redis-cluster/$&#123;port&#125;/conf/redis.conf &amp;&amp; mkdir -p /usr/local/server/redis-cluster/$&#123;port&#125;/data;<br>done<br>echo &quot;正在启动redis容器&quot;;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建6个redis容器</span><br>for port in `seq 7001 7006`;<br>do<br>	docker run -d -it -p $&#123;port&#125;:$&#123;port&#125; -p 1$&#123;port&#125;:1$&#123;port&#125; -v /usr/local/server/redis-cluster/$&#123;port&#125;/conf/redis.conf:/usr/local/etc/redis/redis.conf -v /usr/local/server/redis-cluster/$&#123;port&#125;/data:/data --privileged=true --restart always --name redis-$&#123;port&#125; --net redis-net --sysctl net.core.somaxconn=1024 redis redis-server /usr/local/etc/redis/redis.conf;<br>done<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查找ip</span><br>for port in `seq 7001 7006`;<br>do<br>	echo  -n &quot;$(docker inspect --format &#x27;&#123;&#123; (index .NetworkSettings.Networks &quot;redis-net&quot;).IPAddress &#125;&#125;&#x27; &quot;redis-$&#123;port&#125;&quot;)&quot;:$&#123;port&#125;&quot; &quot;;<br>done<br><span class="hljs-meta prompt_">#</span><span class="language-bash">换行</span><br>echo -e &quot;\n&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">输入信息</span><br>read -p &quot;请把输入要启动的docker容器名称，默认redis-7001：&quot; DOCKER_NAME<br><span class="hljs-meta prompt_">#</span><span class="language-bash">判断是否为空</span><br>if [ ! $DOCKER_NAME ]; <br>	then DOCKER_NAME=&#x27;redis-7001&#x27;; <br>fi<br><span class="hljs-meta prompt_">#</span><span class="language-bash">进入容器</span><br>docker exec -it redis-7001 /bin/bash<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除容器</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">docker <span class="hljs-built_in">rm</span> -f $(docker ps -a |  grep <span class="hljs-string">&quot;redis-*&quot;</span>  | awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><br></code></pre></td></tr></table></figure>

<blockquote>
<p>创建删除脚本</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br>echo &quot;正在停止所有redis容器&quot;;<br>docker stop $(docker ps -a |  grep &quot;redis-*&quot;  | awk &#x27;&#123;print $1&#125;&#x27;)<br>echo &quot;正在删除所有redis容器&quot;;<br>docker rm -f $(docker ps -a |  grep &quot;redis-*&quot;  | awk &#x27;&#123;print $1&#125;&#x27;)<br>echo &quot;正在删除redis-net网络&quot;;<br>docker network rm redis-net<br>echo &quot;正在删除/usr/local/server目录&quot;;<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">rm</span> -rf /usr/local/server</span><br>rm -rf 7001 7002 7003 7004 7005 7006<br><br></code></pre></td></tr></table></figure>

<h3 id="执行脚本-创建容器-创建集群"><a href="#执行脚本-创建容器-创建集群" class="headerlink" title="执行脚本,创建容器,创建集群"></a>执行脚本,创建容器,创建集群</h3><blockquote>
<p>执行redis.sh脚本,创建容器,创建集群:</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">1 执行脚本 创建容器</span><br>./redis.sh<br>[root@localhost redis-cluster]# ./redis.sh <br>请输入本机IP地址：192.168.2.110<br>正在下载redis-cluster.tmpl配置模板，请手动下载redis-cluster.tmpl文件并复制到/usr/local/server/redis-cluster目录<br>正在创建redis-net网络<br>2f24ef5a195f41775f7cd85d56218d6a7f34591f349c7c835d26b6c4ec9be019<br>正在创建redis配置文件<br>正在启动redis容器<br>df2ceae9f7e44a2ebe4727d06717db7f636693ef8a2ff42458ce7e3cf5738937<br>86e34c9145760f65394615e221ec886d9634775966cfd30bb33a41a2ba0b8963<br>fdda9586b0987c6d207b840290e5c21fc1ca624574404a3db744d54bdc074177<br>f0c725bc27884e319a7d16575dc919063a8999d2d6ab1a62773af7ce3aee227f<br>9a2373144fed4b48fb9a168cdc1ecb2fbbd3d5f08a8314580c6e4a5d2216ca32<br>1d0ed018e4c6ec2f6b292f668ac6d47658a183a7b5aa5839395eb098c2e46356<br>172.18.0.2:7001 172.18.0.3:7002 172.18.0.4:7003 172.18.0.5:7004 172.18.0.6:7005 172.18.0.7:7006 <br><span class="hljs-meta prompt_">#</span><span class="language-bash">按回车确认</span><br>请把输入要启动的docker容器名称，默认redis-7001：<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">2 创建集群</span><br>cd /usr/local/bin/<br><span class="hljs-meta prompt_">#</span><span class="language-bash">进入到任意一个安装好的redis节点的bin目录，里面有个脚本对象redis-cli，然后执行集群创建</span> <br><span class="hljs-meta prompt_">#</span><span class="language-bash">--cluster-replicas 1 表示每个主节点有一个从节点</span><br>./redis-cli --cluster create 172.18.0.2:7001 172.18.0.3:7002 172.18.0.4:7003 172.18.0.5:7004 172.18.0.6:7005 172.18.0.7:7006 --cluster-replicas 1<br><br></code></pre></td></tr></table></figure>

<h3 id="验证集群是否创建成功"><a href="#验证集群是否创建成功" class="headerlink" title="验证集群是否创建成功"></a>验证集群是否创建成功</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">进入任意一个节点</span><br>cd /usr/local/bin<br><span class="hljs-meta prompt_">#</span><span class="language-bash">连接任意节点</span><br> ./redis-cli -p 7001 -c<br><span class="hljs-meta prompt_"> #</span><span class="language-bash">执行赋值操作,可看到进行了重定向操作:7001重定向到了7003,说明集群创建成功.</span><br><span class="hljs-meta prompt_"> #</span><span class="language-bash">重定向原理:redis根据key值进行crc16%16384,计算出该key应该存到哪个节点的哈希槽中</span><br> 127.0.0.1:7001&gt; set username zhangsan<br><span class="hljs-meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [14315] located at 192.168.2.110:7003</span><br>OK<br>192.168.2.110:7003&gt; <br><span class="hljs-meta prompt_">#</span><span class="language-bash">也可以在节点中执行cluster nodes查看集群中节点信息,及哈希槽分配信息.</span><br>192.168.2.110:7003&gt; cluster nodes<br>76579cdead091c604e60e03454bab68ae69caa36 192.168.2.110:7004@17004 slave 52c2332c4271dba57d3be960d5feef2334b767e5 0 1611586728573 3 connected<br>b7dde8f6eb6f0385303e45bc54c588e8ea422acf 192.168.2.110:7005@17005 slave 8bddaceb3363a9675e48e6a76c4194c50cc545ac 0 1611586729588 1 connected<br>52c2332c4271dba57d3be960d5feef2334b767e5 192.168.2.110:7003@17003 myself,master - 0 1611586727000 3 connected 10923-16383<br>8bddaceb3363a9675e48e6a76c4194c50cc545ac 192.168.2.110:7001@17001 master - 0 1611586729000 1 connected 0-5460<br>4967d4c7cd28c8601eb9de843f1a1d449a343a7c 192.168.2.110:7006@17006 slave 21d108f7cb03af71f707fb314b730a76c33b8c74 0 1611586728000 2 connected<br>21d108f7cb03af71f707fb314b730a76c33b8c74 192.168.2.110:7002@17002 master - 0 1611586727561 2 connected 5461-10922<br>192.168.2.110:7003&gt; <br></code></pre></td></tr></table></figure>



<h2 id="创建集群遇到的问题"><a href="#创建集群遇到的问题" class="headerlink" title="创建集群遇到的问题"></a>创建集群遇到的问题</h2><h3 id="rpc-error-code-2-desc-oci-runtime-error-exec-failed-container-linux-go-247-starting-containe"><a href="#rpc-error-code-2-desc-oci-runtime-error-exec-failed-container-linux-go-247-starting-containe" class="headerlink" title="rpc error: code &#x3D; 2 desc &#x3D; oci runtime error: exec failed: container_linux.go:247: starting containe"></a>rpc error: code &#x3D; 2 desc &#x3D; oci runtime error: exec failed: container_linux.go:247: starting containe</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看我的docker 版本</span><br>docker --version<br>Docker version 1.13.1, build 07f3374/1.13.1<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">更新yum 即可修复 （如果yum的仓库连接不成功， 可以使用阿里仓库）</span><br> yum update -y<br></code></pre></td></tr></table></figure>

<h3 id="创建集群后-一直点点点等待连接"><a href="#创建集群后-一直点点点等待连接" class="headerlink" title="创建集群后,一直点点点等待连接"></a>创建集群后,一直点点点等待连接</h3><blockquote>
<p>相关端口未打开</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">firewall-cmd --zone=public --add-port=7001/tcp --permanent   # 开放7001端口<br>firewall-cmd --zone=public --remove-port=17001/tcp --permanent  #关闭17001端口<br>firewall-cmd --reload   # 配置立即生效<br></code></pre></td></tr></table></figure>


</blockquote>
<h2 id="集群的扩容"><a href="#集群的扩容" class="headerlink" title="集群的扩容"></a>集群的扩容</h2><h3 id="通过启动两个节点7007-7008-一主一从"><a href="#通过启动两个节点7007-7008-一主一从" class="headerlink" title="通过启动两个节点7007 7008,一主一从"></a>通过启动两个节点7007 7008,一主一从</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">docker安装Redis这里编写了一个脚本，安装脚本 redis-port.sh 如下</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span> <br><span class="hljs-meta prompt_">#</span><span class="language-bash">在/usr/local/server/redis-cluster下生成conf和data目标，并生成配置信息</span> <br><span class="hljs-meta prompt_">#</span><span class="language-bash">换行</span> <br>echo -e &quot;\n&quot; <br><span class="hljs-meta prompt_">#</span><span class="language-bash">输入信息</span> <br>read -p &quot;请输入容器端口：&quot; DOCKER_PORT<br><span class="hljs-meta prompt_">#</span><span class="language-bash">输入端口赋值</span><br>port=$DOCKER_PORT;<br>echo -e &quot;$port&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建配置文件</span><br>mkdir -p ./$&#123;port&#125;/conf &amp;&amp; PORT=$&#123;port&#125; envsubst &lt; ./redis-cluster.tmpl &gt; ./$&#123;port&#125;/conf/redis.conf &amp;&amp; mkdir -p ./$&#123;port&#125;/data;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建redis容器</span><br>docker run -d -it -p $&#123;port&#125;:$&#123;port&#125; -p 1$&#123;port&#125;:1$&#123;port&#125; -v /usr/local/server/redis-cluster/$&#123;port&#125;/conf/redis.conf:/usr/local/etc/redis/redis.conf -v /usr/local/server/redis-cluster/$&#123;port&#125;/data:/data --privileged=true --restart always --name redis-$&#123;port&#125; --net redis-net --sysctl net.core.somaxconn=1024 redis redis-server /usr/local/etc/redis/redis.conf;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查找ip</span><br>echo -n &quot;启动$(docker inspect --format &#x27;&#123;&#123; (index .NetworkSettings.Networks &quot;redis- net&quot;).IPAddress &#125;&#125;&#x27; &quot;redis-$&#123;port&#125;&quot;)&quot;:$&#123;port&#125;&quot; 成功！&quot;;<br>echo -e &quot;\n&quot;<br></code></pre></td></tr></table></figure>

<h3 id="启动完成-把7007加进集群-并分配哈希槽"><a href="#启动完成-把7007加进集群-并分配哈希槽" class="headerlink" title="启动完成,把7007加进集群,并分配哈希槽."></a>启动完成,把7007加进集群,并分配哈希槽.</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">1 查看主节点信息 和从节点信息</span><br>[root@localhost bin]# ./redis-cli -p 7001 cluster nodes|grep master<br>52c2332c4271dba57d3be960d5feef2334b767e5 192.168.2.110:7003@17003 master - 0 1611589610513 3 connected 10923-16383<br>8bddaceb3363a9675e48e6a76c4194c50cc545ac 192.168.2.110:7001@17001 myself,master - 0 1611589610000 1 connected 0-5460<br>21d108f7cb03af71f707fb314b730a76c33b8c74 192.168.2.110:7002@17002 master - 0 1611589611527 2 connected 5461-10922<br>[root@localhost bin]# ./redis-cli -p 7001 cluster nodes|grep slave<br>4967d4c7cd28c8601eb9de843f1a1d449a343a7c 192.168.2.110:7006@17006 slave 21d108f7cb03af71f707fb314b730a76c33b8c74 0 1611589702041 2 connected<br>76579cdead091c604e60e03454bab68ae69caa36 192.168.2.110:7004@17004 slave 52c2332c4271dba57d3be960d5feef2334b767e5 0 1611589702000 3 connected<br>b7dde8f6eb6f0385303e45bc54c588e8ea422acf 192.168.2.110:7005@17005 slave 8bddaceb3363a9675e48e6a76c4194c50cc545ac 0 1611589701540 1 connected<br>[root@localhost bin]# <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">2 把7007添加到集群中</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">命令说明 将节点192.168.2.110:7007添加到节点192.168.2.110:7001所在的集群中</span><br>./redis-cli --cluster add-node 192.168.2.110:7007 192.168.2.110:7001<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">3 再次查看主节点信息,已能看到7007节点,但是7007没有分配哈希槽</span><br>[root@localhost bin]# ./redis-cli -p 7001 cluster nodes|grep master<br>52c2332c4271dba57d3be960d5feef2334b767e5 192.168.2.110:7003@17003 master - 0 1611590983590 3 connected 10923-16383<br>8bddaceb3363a9675e48e6a76c4194c50cc545ac 192.168.2.110:7001@17001 myself,master - 0 1611590981000 1 connected 0-5460<br>21d108f7cb03af71f707fb314b730a76c33b8c74 192.168.2.110:7002@17002 master - 0 1611590983000 2 connected 5461-10922<br>eaf055c10e03a10e6493194bc3389d65919c3ecb 192.168.2.110:7007@17007 master - 0 1611590983590 0 connected<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">4 重新分配哈希槽</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">我们将 7001,7002,7003 中的 100 个哈希槽挪给 7007 ，命令如下：</span><br>./redis-cli --cluster reshard 192.168.2.110:7001 --cluster-from 8bddaceb3363a9675e48e6a76c4194c50cc545ac,21d108f7cb03af71f707fb314b730a76c33b8c74,52c2332c4271dba57d3be960d5feef2334b767e5 --cluster-to eaf055c10e03a10e6493194bc3389d65919c3ecb --cluster-slots 100<br><span class="hljs-meta prompt_"># </span><span class="language-bash">参数说明</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">--cluster-from：表示slot目前所在的节点的node ID，多个ID用逗号分隔</span> <br><span class="hljs-meta prompt_">#</span><span class="language-bash">--cluster-to：表示需要新分配节点的node ID</span> <br><span class="hljs-meta prompt_">#</span><span class="language-bash">--cluster-slots：分配的slot数量</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">5 再次查看主节点信息,哈希槽已成功分配给7007</span><br>[root@localhost bin]# ./redis-cli -p 7001 cluster nodes|grep master<br>52c2332c4271dba57d3be960d5feef2334b767e5 192.168.2.110:7003@17003 master - 0 1611591101000 3 connected 10956-16383<br>8bddaceb3363a9675e48e6a76c4194c50cc545ac 192.168.2.110:7001@17001 myself,master - 0 1611591102000 1 connected 33-5460<br>21d108f7cb03af71f707fb314b730a76c33b8c74 192.168.2.110:7002@17002 master - 0 1611591101598 2 connected 5495-10922<br>eaf055c10e03a10e6493194bc3389d65919c3ecb 192.168.2.110:7007@17007 master - 0 1611591102514 7 connected 0-32 5461-5494 10923-10955<br>[root@localhost bin]# <br></code></pre></td></tr></table></figure>

<h3 id="把7008加进7007的从节点"><a href="#把7008加进7007的从节点" class="headerlink" title="把7008加进7007的从节点"></a>把7008加进7007的从节点</h3><blockquote>
<p>我们需要往集群中给 7007 节点添加一个从节点 7008 ，添加从节点的主要目的是提高高可用，防止主节点宕机后该节点无法提供服务。添加从节点命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">./redis-cli --cluster add-node 192.168.2.110:7008 192.168.2.110:7007 --cluster-slave --cluster-master-id eaf055c10e03a10e6493194bc3389d65919c3ecb</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash"><span class="hljs-comment">#参数说明</span></span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash"><span class="hljs-comment">#add-node: 后面的分别跟着新加入的slave和slave对应的master</span></span> <br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash"><span class="hljs-comment">#cluster-slave：表示加入的是slave节点</span></span> <br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash"><span class="hljs-comment">#--cluster-master-id：表示slave对应的master的node ID</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash"><span class="hljs-comment">#再次查看从节点信息,7008已加入</span></span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">[root@localhost bin]<span class="hljs-comment"># ./redis-cli -p 7001 cluster nodes|grep slavebdcc8f4553c05fe408a75045ca910b5156d5a11c 192.168.2.110:7008@17008 slave eaf055c10e03a10e6493194bc3389d65919c3ecb 0 1611591482000 7 connected</span></span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">4967d4c7cd28c8601eb9de843f1a1d449a343a7c 192.168.2.110:7006@17006 slave 21d108f7cb03af71f707fb314b730a76c33b8c74 0 1611591481472 2 connected</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">76579cdead091c604e60e03454bab68ae69caa36 192.168.2.110:7004@17004 slave 52c2332c4271dba57d3be960d5feef2334b767e5 0 1611591482181 3 connected</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">b7dde8f6eb6f0385303e45bc54c588e8ea422acf 192.168.2.110:7005@17005 slave 8bddaceb3363a9675e48e6a76c4194c50cc545ac 0 1611591482484 1 connected</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">[root@localhost bin]<span class="hljs-comment">#</span></span> <br></code></pre></td></tr></table></figure>


</blockquote>
<h2 id="集群的收容"><a href="#集群的收容" class="headerlink" title="集群的收容"></a>集群的收容</h2><h3 id="移除从节点"><a href="#移除从节点" class="headerlink" title="移除从节点"></a><strong>移除从节点</strong></h3><p>移除 7007 的从节点 7008 ，命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看从节点</span><br>root@579a0ecdc975:/usr/local/bin# ./redis-cli -p 7001 cluster nodes | grep slave<br>b7dde8f6eb6f0385303e45bc54c588e8ea422acf 192.168.2.110:7005@17005 slave,fail? 8bddaceb3363a9675e48e6a76c4194c50cc545ac 1611969411737 1611969410827 1 connected<br>bdcc8f4553c05fe408a75045ca910b5156d5a11c 192.168.2.110:7008@17008 slave,fail? eaf055c10e03a10e6493194bc3389d65919c3ecb 1611969413356 1611969410827 7 connected<br>4967d4c7cd28c8601eb9de843f1a1d449a343a7c 192.168.2.110:7006@17006 slave,fail? 21d108f7cb03af71f707fb314b730a76c33b8c74 1611969412748 1611969410827 2 connected<br>76579cdead091c604e60e03454bab68ae69caa36 192.168.2.110:7004@17004 slave,fail? 52c2332c4271dba57d3be960d5feef2334b767e5 1611969413356 1611969410827 3 connected<br>root@579a0ecdc975:/usr/local/bin# <br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除7008</span><br>[root@localhost bin]# ./redis-cli --cluster del-node 192.168.2.110:7008 bdcc8f4553c05fe408a75045ca910b5156d5a11c<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Removing node bdcc8f4553c05fe408a75045ca910b5156d5a11c from cluster 192.168.2.110:7008</span><br>Could not connect to Redis at 192.168.2.110:7008: No route to host<br>[root@localhost bin]# <br></code></pre></td></tr></table></figure>



<p>参数说明：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">del-node:删除节点，后面跟着slave节点的 ip:port 和node ID<br></code></pre></td></tr></table></figure>

<p>删除后，我们再来查看集群节点，此时再无7008节点。</p>
<p><img src="https://i.loli.net/2021/01/30/oxvBH9EgWXTjSGA.png" srcset="/img/loading.gif" lazyload alt="image-20210130095713026"></p>
<h3 id="迁移Master的Slot"><a href="#迁移Master的Slot" class="headerlink" title="迁移Master的Slot"></a>迁移Master的Slot</h3><p>我们需要将 7007 节点的哈希槽迁移到 7001,7002,7003 节点上，仍然用上面用过的 redis-cli –cluster reshard</p>
<p>语法，命令如下：</p>
<p>第1次迁移：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./redis-cli --cluster reshard 192.168.2.114:7007 --cluster-from 443096af2ff8c1e89f1160faed4f6a02235822a7 --cluster-to 80a69bb8af3737bce2913b2952b4456430a89eb3 --cluster-slots 33 --cluster-yes<br></code></pre></td></tr></table></figure>

<p>查看集群节点：</p>
<p><img src="https://i.loli.net/2021/01/30/iIGRsyC3n6l9w24.png" srcset="/img/loading.gif" lazyload alt="image-20210130100001634"></p>
<p>第2次迁移：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">./redis-cli --cluster reshard 192.168.211.141:7007 --cluster-from <br>443096af2ff8c1e89f1160faed4f6a02235822a7 --cluster-to <br>c9687b2ebec8b99ee14fcbb885b5c3439c58827f --cluster-slots 34 --cluster-yes <br></code></pre></td></tr></table></figure>



<p>第3次迁移：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">./redis-cli --cluster reshard 192.168.211.141:7007 --cluster-from <br>443096af2ff8c1e89f1160faed4f6a02235822a7 --cluster-to <br>612e4af8eae48426938ce65d12a7d7376b0b37e3 --cluster-slots 33 --cluster-yes<br></code></pre></td></tr></table></figure>

<p>集群状态查询：</p>
<p><img src="https://i.loli.net/2021/01/30/daySTQE9livjgXJ.png" srcset="/img/loading.gif" lazyload alt="image-20210130100113825"></p>
<h3 id="删除7007主节点"><a href="#删除7007主节点" class="headerlink" title="删除7007主节点"></a>删除7007主节点</h3><p>删除节点命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./redis-cli --cluster del-node 192.168.211.141:7007 443096af2ff8c1e89f1160faed4f6a02235822a7<br></code></pre></td></tr></table></figure>

<p>集群节点查看：<img src="https://i.loli.net/2021/01/30/sLbq7CDHG39WI1A.png" srcset="/img/loading.gif" lazyload alt="image-20210130100155133"></p>
<h1 id="集群面试题"><a href="#集群面试题" class="headerlink" title="集群面试题"></a>集群面试题</h1><ul>
<li><p>问题一: Redis的多数据库机制,了解多少?</p>
<blockquote>
<p>正常版: Redis支持多个数据库,并且每个数据库的数据是隔离的不能共享,<strong>单机</strong>下的redis可以支持16个数据库(dbo ~db15) ;<br>高调版:在Redis Cluster集群架构下只有一个数据库空间,即dbo,因此,我们没有使用Redis的多数据库功能！</p>
</blockquote>
</li>
<li><p>问题二:懂Redis的批量操作么?</p>
<blockquote>
<p>正常版:懂一点。比如mset, mget操作等, blabla…<br>高调版:在生产上采用的是Redis Cluster集群架构,不同的key会划分到不同的slot中,因此直接使用mset或者mget等操作是行不通的。</p>
</blockquote>
</li>
<li><p>问题三: Redis集群机制中,你觉得有什么不足的地方吗?.</p>
<blockquote>
<p>正常版:不知道<br>高调版:假设有一个key,对应的value是Hash类型的。如果Hash对象非常大,是不支持映射到不同节点的!只能映射到集群中的一个节点上!还有就是做批量操作比较麻烦!</p>
</blockquote>
</li>
<li><p>问题四:在Redis集群模式下,如何进行批量操作?</p>
<blockquote>
<p>正常版：不知道<br>高调版：如果执行的key数是比较少,就不用mget了,就用串行get操作。如果真的需要执行的key很多,就使用Hashtag保证这些key映射到同一台redis节点上。简单来说语法如下:</p>
</blockquote>
<blockquote>
<p> 对于key为(foo}.student1, {foo}.student2, {foo}.student3,这类key一定是在同一个redis节点上。因为key中”{}”之间的字符串就是当前key的hash tags,只有key中{}中的部分才被用来做hash,因此计算出来的redis节点一定是同一个!</p>
</blockquote>
</li>
<li><p>问题五:懂Redis事务么?.</p>
<blockquote>
<p>正常版: Redis事务是一些列redis命令的集合,blabla..<br>高调版：在生产上采用的是Redis Cluster集群架构，不同的key是有可能分配在不同的Redis节点上的,在这种情况下Redis的事务机制是不生效的。其次，Redis事务不支持回滚操作,简直是鸡肋,基本不用!</p>
</blockquote>
</li>
</ul>
<h1 id="缓存穿透-缓存击穿-缓存雪崩"><a href="#缓存穿透-缓存击穿-缓存雪崩" class="headerlink" title="缓存穿透 缓存击穿 缓存雪崩"></a>缓存穿透 缓存击穿 缓存雪崩</h1><p><strong>缓存穿透</strong>: key对应的数据在数据源并不存在,每次针对此key的请求从缓存获取不到,请求都会到数据源,从而可能压垮数据源。<br>                <strong>一言以蔽之:查询Key,缓存和数据源都没有,频繁查询数据源</strong></p>
<blockquote>
<p>比如用一个不存在的用户id获取用户信息,无论论缓存还是数据库都没有,若黑客利用此漏洞进行攻击可能压垮数据库。<br>解决缓存穿透的方案主要有两种:.<br><strong>方案一:当查询不存在时,也将结果保存在缓存中</strong>。但是这可能会存在一种问题:大量没有查询结果的请求保存在缓存中,这时我们就可以将这些请求的key设置得更短一些; .<br><strong>方案二:<strong>提前过滤掉不合法的请求,可以使用</strong>Redis中布隆过滤器</strong>(快速过滤不存在的key,但是对于已经存在的key无法准确判断是否存在);</p>
</blockquote>
<p><strong>缓存击穿</strong>: key对应的数据存在,但在redis中过期,此时若有大量并发请求过来,这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存,这个时候大并发的请求可能会瞬间把后端DB压垮</p>
<blockquote>
<p>​	<strong>一言以蔽之:查询Key,缓存过期,大量并发,频繁查询数据派</strong></p>
<p>业界比较常用的做法:<strong>使用互斥锁</strong>。简单地来说,就是在缓存失效的时候(判断拿出来的值为空) ,不是立即去load db (查询数据库) ,而是先使用缓存工具的某些带成功操作返回值的操作(比如Redis的SETNX或者Memcache的ADD)去set一个mutex key,就是只让一个线程构建缓存,其他线程等待构建缓存的线程执行完,重新从缓存获取数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">string <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span>&#123;<br>  <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> redis.get(key);<br>	<span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>)&#123;<br>		<span class="hljs-comment">//如果key不存在,则设置为1</span><br>		<span class="hljs-keyword">if</span> (redis.setnx(key_mutex, <span class="hljs-string">&quot;1&quot;</span>)) &#123; <br>			<span class="hljs-comment">//设置key的过期时间为3分钟</span><br>			redis.expire(key_mutex, <span class="hljs-number">3</span> * <span class="hljs-number">60</span>) ;<br>			<span class="hljs-comment">//从db中加载数据，但注意：只有一个线程能进入到这里,其他线程访问的时候已有课key_mutex</span><br>			value =db.get(key); <br>			<span class="hljs-comment">//从数据库中加载成功,则设置对应的数据</span><br>			redis.set(key, value);<br>			redis.delete(key_mutex); <br> 	 	&#125; <span class="hljs-keyword">else</span> &#123; <br>			<span class="hljs-comment">//其他线程休息50毫秒后重试</span><br>    	Thread.sleep (<span class="hljs-number">50</span>);<br>			get(key);<br>  	&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</blockquote>
<p><strong>缓存雪崩</strong>:当缓存服务器重启或者大量缓存集中在某一个时间段失效,这样在失效的时候,也会给后端系统(比如DB)带来很大压力。</p>
<blockquote>
<p><strong>一言以蔽之:缓存不可用(服务器重启或缓存失效) ,频繁查询数据源</strong><br>与缓存击穿的区别在于这里针对很多key缓存,前者则是某一个key。</p>
<p>缓存失效时的雪崩效应对底层系统的冲击非常可怕!大多数系统设计者考虑用<strong>加锁或者队列</strong>的方式保证来保证不会有大量的线程对数据库一次性进行读写,从而避免失效时大量的并发请求落到底层存储系统上。还有一个简单方案就时**将缓存失效时间分散开,**比如可以在原有的失效时间基础上增加一个随机值,比如1-5分钟随机,这样每一个缓存的过期时间的重复率就会降低,就很难引发集体失效的事件。</p>
</blockquote>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="category-chain-item">数据库</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/redis/" class="print-no-link">#redis</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>redis</div>
      <div>http://www.lifeab.com/2021/01/23/redis/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Wick</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2021年1月23日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/01/26/%E7%BC%96%E5%86%99%E4%BC%98%E9%9B%85%E9%AB%98%E6%95%88%E7%9A%84java%E4%BB%A3%E7%A0%81/" title="编写高效优雅java代码">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">编写高效优雅java代码</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/01/02/SQL%E4%BC%98%E5%8C%96/" title="SQL语句性能提升">
                        <span class="hidden-mobile">SQL语句性能提升</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'blydd/hexo');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo够优秀</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid主题够帅气</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
